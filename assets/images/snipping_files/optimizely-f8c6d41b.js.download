(function(He){"use strict";var Xr=Object.defineProperty,Jr=(e,t)=>Xr(e,"name",{value:t,configurable:!0});function Ut(){return typeof Blob=="function"&&typeof PerformanceObserver=="function"&&typeof Intl<"u"&&typeof MutationObserver<"u"&&typeof URLSearchParams<"u"&&typeof WebSocket<"u"&&typeof IntersectionObserver<"u"&&typeof AbortController<"u"&&typeof queueMicrotask<"u"&&typeof TextEncoder<"u"&&typeof TextDecoder<"u"&&typeof customElements<"u"&&typeof HTMLDetailsElement<"u"&&"fromEntries"in Object&&"entries"in FormData.prototype&&"toggleAttribute"in Element.prototype&&"flatMap"in Array.prototype&&"replaceChildren"in Element.prototype}Jr(Ut,"capableBrowser");var Zr=Object.defineProperty,Qr=(e,t)=>Zr(e,"name",{value:t,configurable:!0});function Dt(e){const t=e.head?.querySelector('meta[name="expected-hostname"]')?.content;if(!t)return!1;const r=t.replace(/\.$/,"").split(".").slice(-2).join("."),n=e.location.hostname.replace(/\.$/,"").split(".").slice(-2).join(".");return r!==n}Qr(Dt,"detectProxySite");let qe;function bt(){return`${Math.round(Math.random()*(Math.pow(2,31)-1))}.${Math.round(Date.now()/1e3)}`}function en(e){const t=`GH1.1.${e}`,r=Date.now(),n=new Date(r+1*365*86400*1e3).toUTCString();let{domain:i}=document;i.endsWith(".github.com")&&(i="github.com"),document.cookie=`_octo=${t}; expires=${n}; path=/; domain=${i}; secure; samesite=lax`}function tn(){let e;const r=document.cookie.match(/_octo=([^;]+)/g);if(!r)return;let n=[0,0];for(const i of r){const[,o]=i.split("="),[,a,...s]=o.split("."),l=a.split("-").map(Number);l>n&&(n=l,e=s.join("."))}return e}function Y(){try{const e=tn();if(e)return e;const t=bt();return en(t),t}catch{return qe||(qe=bt()),qe}}var ie="<unknown>";function rn(e){var t=e.split(`
`);return t.reduce(function(r,n){var i=an(n)||un(n)||fn(n)||gn(n)||pn(n);return i&&r.push(i),r},[])}var nn=/^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,on=/\((\S*)(?::(\d+))(?::(\d+))\)/;function an(e){var t=nn.exec(e);if(!t)return null;var r=t[2]&&t[2].indexOf("native")===0,n=t[2]&&t[2].indexOf("eval")===0,i=on.exec(t[2]);return n&&i!=null&&(t[2]=i[1],t[3]=i[2],t[4]=i[3]),{file:r?null:t[2],methodName:t[1]||ie,arguments:r?[t[2]]:[],lineNumber:t[3]?+t[3]:null,column:t[4]?+t[4]:null}}var sn=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i;function un(e){var t=sn.exec(e);return t?{file:t[2],methodName:t[1]||ie,arguments:[],lineNumber:+t[3],column:t[4]?+t[4]:null}:null}var ln=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?|[^@]*bundle)(?::(\d+))?(?::(\d+))?\s*$/i,cn=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i;function fn(e){var t=ln.exec(e);if(!t)return null;var r=t[3]&&t[3].indexOf(" > eval")>-1,n=cn.exec(t[3]);return r&&n!=null&&(t[3]=n[1],t[4]=n[2],t[5]=null),{file:t[3],methodName:t[1]||ie,arguments:t[2]?t[2].split(","):[],lineNumber:t[4]?+t[4]:null,column:t[5]?+t[5]:null}}var dn=/^\s*(?:([^@]*)(?:\((.*?)\))?@)?(\S.*?):(\d+)(?::(\d+))?\s*$/i;function pn(e){var t=dn.exec(e);return t?{file:t[3],methodName:t[1]||ie,arguments:[],lineNumber:+t[4],column:t[5]?+t[5]:null}:null}var En=/^\s*at (?:((?:\[object object\])?[^\\/]+(?: \[as \S+\])?) )?\(?(.*?):(\d+)(?::(\d+))?\)?\s*$/i;function gn(e){var t=En.exec(e);return t?{file:t[2],methodName:t[1]||ie,arguments:[],lineNumber:+t[3],column:t[4]?+t[4]:null}:null}var _n=Object.defineProperty,pe=(e,t)=>_n(e,"name",{value:t,configurable:!0});function Ee(e){const t=document.querySelectorAll(e);if(t.length>0)return t[t.length-1]}pe(Ee,"queryLast");function Ct(){const e=Ee("meta[name=analytics-location]");return e?e.content:window.location.pathname}pe(Ct,"pagePathname");function Vt(){const e=Ee("meta[name=analytics-location-query-strip]");let t="";e||(t=window.location.search);const r=Ee("meta[name=analytics-location-params]");r&&(t+=(t?"&":"?")+r.content);for(const n of document.querySelectorAll("meta[name=analytics-param-rename]")){const i=n.content.split(":",2);t=t.replace(new RegExp(`(^|[?&])${i[0]}($|=)`,"g"),`$1${i[1]}$2`)}return t}pe(Vt,"pageQuery");function Ye(){return`${window.location.protocol}//${window.location.host}${Ct()+Vt()}`}pe(Ye,"requestUri");var hn=Object.defineProperty,B=(e,t)=>hn(e,"name",{value:t,configurable:!0});let Pt=!1,xt=0;const vn=Date.now();function In(e){e.error&&ge(he(_e(e.error)))}B(In,"reportEvent");async function mn(e){if(!!e.promise)try{await e.promise}catch(t){ge(he(_e(t)))}}B(mn,"reportPromiseRejectionEvent");function Mt(e,t={}){e&&e.name!=="AbortError"&&ge(he(_e(e),t))}B(Mt,"reportError");async function ge(e){if(!wt())return;const t=document.head?.querySelector('meta[name="browser-errors-url"]')?.content;if(!!t){if(kt(e.error.stacktrace)){Pt=!0;return}xt++;try{await fetch(t,{method:"post",body:JSON.stringify(e)})}catch{}}}B(ge,"report");function _e(e){return{type:e.name,value:e.message,stacktrace:$e(e)}}B(_e,"formatError");function he(e,t={}){return Object.assign({error:e,sanitizedUrl:Ye()||window.location.href,readyState:document.readyState,referrer:document.referrer,timeSinceLoad:Math.round(Date.now()-vn),user:We()||void 0,bundler:Bt()},t)}B(he,"errorContext");function $e(e){return rn(e.stack||"").map(t=>({filename:t.file||"",function:String(t.methodName),lineno:(t.lineNumber||0).toString(),colno:(t.column||0).toString()}))}B($e,"stacktrace");const Ft=/(chrome|moz|safari)-extension:\/\//;function kt(e){return e.some(t=>Ft.test(t.filename)||Ft.test(t.function))}B(kt,"isExtensionError");function We(){const e=document.head?.querySelector('meta[name="user-login"]')?.content;return e||`anonymous-${Y()}`}B(We,"pageUser");let ze=!1;window.addEventListener("pageshow",()=>ze=!1),window.addEventListener("pagehide",()=>ze=!0);function wt(){return!ze&&!Pt&&xt<10&&Ut()&&!Dt(document)}B(wt,"reportable");function Bt(){return"System"in window?"rollup":"webpack"}B(Bt,"bundlerName"),typeof BroadcastChannel=="function"&&new BroadcastChannel("shared-worker-error").addEventListener("message",t=>{Mt(t.data.error)});var P=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function yn(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach(function(r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}),t}var S={},$={};Object.defineProperty($,"__esModule",{value:!0});var Xe=function(){function e(){}return e.prototype.handleError=function(t){},e}();$.NoopErrorHandler=Xe;var Je=new Xe;function Rn(e){Je=e}$.setErrorHandler=Rn;function Tn(){return Je}$.getErrorHandler=Tn;function On(){Je=new Xe}$.resetErrorHandler=On;var Ze={};(function(e){Object.defineProperty(e,"__esModule",{value:!0}),function(t){t[t.NOTSET=0]="NOTSET",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARNING=3]="WARNING",t[t.ERROR=4]="ERROR"}(e.LogLevel||(e.LogLevel={}))})(Ze);var H={},u={},Gt={v4(){return crypto.randomUUID()}},Nn=Object.freeze({__proto__:null,default:Gt}),An=yn(Nn);(function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=An;function r(){return new Date().getTime()}e.getTimestamp=r;function n(){return t.v4()}e.generateUUID=n;function i(d,p){for(var g=!1,T=Object.keys(d),A=0;A<T.length;A++)if(p===d[T[A]]){g=!0;break}return g}e.isValidEnum=i;function o(d,p){var g={};return d.forEach(function(T){var A=p(T);g[A]=g[A]||[],g[A].push(T)}),a(g)}e.groupBy=o;function a(d){return Object.keys(d).map(function(p){return d[p]})}e.objectValues=a;function s(d){return Object.keys(d).map(function(p){return[p,d[p]]})}e.objectEntries=s;function l(d,p){for(var g,T=0,A=d;T<A.length;T++){var X=A[T];if(p(X)){g=X;break}}return g}e.find=l;function c(d,p){var g={};return d.forEach(function(T){var A=p(T);g[A]=T}),g}e.keyBy=c;function f(d){for(var p=[],g=1;g<arguments.length;g++)p[g-1]=arguments[g];var T=0;return d.replace(/%s/g,function(){var A=p[T++],X=typeof A;return X==="function"?A():X==="string"?A:String(A)})}e.sprintf=f,function(d){d.ACTIVATE="ACTIVATE:experiment, user_id,attributes, variation, event",d.DECISION="DECISION:type, userId, attributes, decisionInfo",d.LOG_EVENT="LOG_EVENT:logEvent",d.OPTIMIZELY_CONFIG_UPDATE="OPTIMIZELY_CONFIG_UPDATE",d.TRACK="TRACK:event_key, user_id, attributes, event_tags, event"}(e.NOTIFICATION_TYPES||(e.NOTIFICATION_TYPES={}))})(u),Object.defineProperty(H,"__esModule",{value:!0});var Sn=$,ve=u,U=Ze,jt={NOTSET:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4};function Qe(e){return typeof e!="string"||(e=e.toUpperCase(),e==="WARN"&&(e="WARNING"),!jt[e])?e:jt[e]}var Kt=function(){function e(){this.defaultLoggerFacade=new Ht,this.loggers={}}return e.prototype.getLogger=function(t){return t?(this.loggers[t]||(this.loggers[t]=new Ht({messagePrefix:t})),this.loggers[t]):this.defaultLoggerFacade},e}(),Ln=function(){function e(t){t===void 0&&(t={}),this.logLevel=U.LogLevel.NOTSET,t.logLevel!==void 0&&ve.isValidEnum(U.LogLevel,t.logLevel)&&this.setLogLevel(t.logLevel),this.logToConsole=t.logToConsole!==void 0?!!t.logToConsole:!0,this.prefix=t.prefix!==void 0?t.prefix:"[OPTIMIZELY]"}return e.prototype.log=function(t,r){if(!(!this.shouldLog(t)||!this.logToConsole)){var n=this.prefix+" - "+this.getLogLevelName(t)+" "+this.getTime()+" "+r;this.consoleLog(t,[n])}},e.prototype.setLogLevel=function(t){t=Qe(t),!ve.isValidEnum(U.LogLevel,t)||t===void 0?this.logLevel=U.LogLevel.ERROR:this.logLevel=t},e.prototype.getTime=function(){return new Date().toISOString()},e.prototype.shouldLog=function(t){return t>=this.logLevel},e.prototype.getLogLevelName=function(t){switch(t){case U.LogLevel.DEBUG:return"DEBUG";case U.LogLevel.INFO:return"INFO ";case U.LogLevel.WARNING:return"WARN ";case U.LogLevel.ERROR:return"ERROR";default:return"NOTSET"}},e.prototype.consoleLog=function(t,r){switch(t){case U.LogLevel.DEBUG:console.log.apply(console,r);break;case U.LogLevel.INFO:console.info.apply(console,r);break;case U.LogLevel.WARNING:console.warn.apply(console,r);break;case U.LogLevel.ERROR:console.error.apply(console,r);break;default:console.log.apply(console,r)}},e}();H.ConsoleLogHandler=Ln;var oe=U.LogLevel.NOTSET,et=null,Ht=function(){function e(t){t===void 0&&(t={}),this.messagePrefix="",t.messagePrefix&&(this.messagePrefix=t.messagePrefix)}return e.prototype.log=function(t,r){this.internalLog(Qe(t),{message:r,splat:[]})},e.prototype.info=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.namedLog(U.LogLevel.INFO,t,r)},e.prototype.debug=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.namedLog(U.LogLevel.DEBUG,t,r)},e.prototype.warn=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.namedLog(U.LogLevel.WARNING,t,r)},e.prototype.error=function(t){for(var r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];this.namedLog(U.LogLevel.ERROR,t,r)},e.prototype.format=function(t){return(this.messagePrefix?this.messagePrefix+": ":"")+ve.sprintf.apply(void 0,[t.message].concat(t.splat))},e.prototype.internalLog=function(t,r){!et||t<oe||(et.log(t,this.format(r)),r.error&&r.error instanceof Error&&Sn.getErrorHandler().handleError(r.error))},e.prototype.namedLog=function(t,r,n){var i;if(r instanceof Error){i=r,r=i.message,this.internalLog(t,{error:i,message:r,splat:n});return}if(n.length===0){this.internalLog(t,{message:r,splat:n});return}var o=n[n.length-1];o instanceof Error&&(i=o,n.splice(-1)),this.internalLog(t,{message:r,error:i,splat:n})},e}(),qt=new Kt;function Un(e){return qt.getLogger(e)}H.getLogger=Un;function Dn(e){et=e}H.setLogHandler=Dn;function bn(e){e=Qe(e),!ve.isValidEnum(U.LogLevel,e)||e===void 0?oe=U.LogLevel.ERROR:oe=e}H.setLogLevel=bn;function Cn(){return oe}H.getLogLevel=Cn;function Vn(){qt=new Kt,oe=U.LogLevel.NOTSET}H.resetLogger=Vn,function(e){function t(r){for(var n in r)e.hasOwnProperty(n)||(e[n]=r[n])}Object.defineProperty(e,"__esModule",{value:!0}),t($),t(Ze),t(H)}(S);var tt={},Ie={};Object.defineProperty(Ie,"__esModule",{value:!0});function Pn(e,t){var r=e.context,n=t.context;return r.accountId===n.accountId&&r.projectId===n.projectId&&r.clientName===n.clientName&&r.clientVersion===n.clientVersion&&r.revision===n.revision&&r.anonymizeIP===n.anonymizeIP&&r.botFiltering===n.botFiltering}Ie.areEventContextsEqual=Pn;var me={},ye={};Object.defineProperty(ye,"__esModule",{value:!0});var xn=S,Mn=xn.getLogger("EventProcessor"),Fn=function(){function e(t){var r=t.timeout,n=t.callback;this.timeout=Math.max(r,0),this.callback=n}return e.prototype.start=function(){this.timeoutId=setTimeout(this.callback,this.timeout)},e.prototype.refresh=function(){this.stop(),this.start()},e.prototype.stop=function(){this.timeoutId&&clearTimeout(this.timeoutId)},e}(),kn=function(){function e(t){var r=t.sink;this.sink=r}return e.prototype.start=function(){},e.prototype.stop=function(){return Promise.resolve()},e.prototype.enqueue=function(t){this.sink([t])},e}();ye.SingleEventQueue=kn;var wn=function(){function e(t){var r=t.flushInterval,n=t.maxQueueSize,i=t.sink,o=t.batchComparator;this.buffer=[],this.maxQueueSize=Math.max(n,1),this.sink=i,this.batchComparator=o,this.timer=new Fn({callback:this.flush.bind(this),timeout:r}),this.started=!1}return e.prototype.start=function(){this.started=!0},e.prototype.stop=function(){this.started=!1;var t=this.sink(this.buffer);return this.buffer=[],this.timer.stop(),t},e.prototype.enqueue=function(t){if(!this.started){Mn.warn("Queue is stopped, not accepting event");return}var r=this.buffer[0];r&&!this.batchComparator(r,t)&&this.flush(),this.buffer.length===0&&this.timer.refresh(),this.buffer.push(t),this.buffer.length>=this.maxQueueSize&&this.flush()},e.prototype.flush=function(){this.sink(this.buffer),this.buffer=[],this.timer.stop()},e}();ye.DefaultEventQueue=wn;var rt={};Object.defineProperty(rt,"__esModule",{value:!0});var Bn=function(){function e(){this.reqsInFlightCount=0,this.reqsCompleteResolvers=[]}return e.prototype.trackRequest=function(t){var r=this;this.reqsInFlightCount++;var n=function(){r.reqsInFlightCount--,r.reqsInFlightCount===0&&(r.reqsCompleteResolvers.forEach(function(i){return i()}),r.reqsCompleteResolvers=[])};t.then(n,n)},e.prototype.onRequestsComplete=function(){var t=this;return new Promise(function(r){t.reqsInFlightCount===0?r():t.reqsCompleteResolvers.push(r)})},e}();rt.default=Bn;var Gn=P&&P.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(me,"__esModule",{value:!0});var jn=Ie,Yt=ye,Kn=S,Hn=u,qn=Gn(rt),Re=Kn.getLogger("EventProcessor"),$t=3e4,Wt=10,Yn=function(){function e(t){var r=t.dispatcher,n=t.flushInterval,i=n===void 0?3e4:n,o=t.maxQueueSize,a=o===void 0?3e3:o,s=t.notificationCenter,l=this;this.dispatcher=r,i<=0&&(Re.warn("Invalid flushInterval "+i+", defaulting to "+$t),i=$t),a=Math.floor(a),a<1&&(Re.warn("Invalid maxQueueSize "+a+", defaulting to "+Wt),a=Wt),a=Math.max(1,a),a>1?this.queue=new Yt.DefaultEventQueue({flushInterval:i,maxQueueSize:a,sink:function(c){return l.drainQueue(c)},batchComparator:jn.areEventContextsEqual}):this.queue=new Yt.SingleEventQueue({sink:function(c){return l.drainQueue(c)}}),this.notificationCenter=s,this.requestTracker=new qn.default}return e.prototype.drainQueue=function(t){var r=this,n=new Promise(function(i){if(Re.debug("draining queue with %s events",t.length),t.length===0){i();return}var o=r.formatEvents(t);r.dispatcher.dispatchEvent(o,function(){i()}),r.notificationCenter&&r.notificationCenter.sendNotifications(Hn.NOTIFICATION_TYPES.LOG_EVENT,o)});return this.requestTracker.trackRequest(n),n},e.prototype.process=function(t){this.queue.enqueue(t)},e.prototype.stop=function(){try{return this.queue.stop(),this.requestTracker.onRequestsComplete()}catch(t){Re.error('Error stopping EventProcessor: "%s"',t.message,t)}return Promise.resolve()},e.prototype.start=function(){this.queue.start()},e}();me.AbstractEventProcessor=Yn;var Te={},nt={};Object.defineProperty(nt,"__esModule",{value:!0});var $n=u,Wn=S,zt=Wn.getLogger("EventProcessor"),zn=function(){function e(t){var r=t.key,n=t.maxValues,i=n===void 0?1e3:n;this.LS_KEY=r,this.maxValues=i}return e.prototype.get=function(t){return this.getMap()[t]||null},e.prototype.set=function(t,r){var n=this.getMap();n[t]=r,this.replace(n)},e.prototype.remove=function(t){var r=this.getMap();delete r[t],this.replace(r)},e.prototype.values=function(){return $n.objectValues(this.getMap())},e.prototype.clear=function(){this.replace({})},e.prototype.replace=function(t){try{window.localStorage&&localStorage.setItem(this.LS_KEY,JSON.stringify(t)),this.clean()}catch(r){zt.error(r)}},e.prototype.clean=function(){var t=this.getMap(),r=Object.keys(t),n=r.length-this.maxValues;if(!(n<1)){var i=r.map(function(a){return{key:a,value:t[a]}});i.sort(function(a,s){return a.value.timestamp-s.value.timestamp});for(var o=0;o<n;o++)delete t[i[o].key];this.replace(t)}},e.prototype.getMap=function(){try{var t=window.localStorage&&localStorage.getItem(this.LS_KEY);if(t)return JSON.parse(t)||{}}catch(r){zt.error(r)}return{}},e}();nt.LocalStorageStore=zn;var Xn=P&&P.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var o in i)i.hasOwnProperty(o)&&(n[o]=i[o])},e(t,r)};return function(t,r){e(t,r);function n(){this.constructor=t}t.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(Te,"__esModule",{value:!0});var Jn=S,Zn=nt,Xt=u,Qn=Jn.getLogger("EventProcessor"),Jt=function(){function e(t){var r=t.eventDispatcher,n=t.store;this.dispatcher=r,this.store=n}return e.prototype.dispatchEvent=function(t,r){this.send({uuid:Xt.generateUUID(),timestamp:Xt.getTimestamp(),request:t},r)},e.prototype.sendPendingEvents=function(){var t=this,r=this.store.values();Qn.debug("Sending %s pending events from previous page",r.length),r.forEach(function(n){try{t.send(n,function(){})}catch{}})},e.prototype.send=function(t,r){var n=this;this.store.set(t.uuid,t),this.dispatcher.dispatchEvent(t.request,function(i){n.store.remove(t.uuid),r(i)})},e}();Te.PendingEventsDispatcher=Jt;var ei=function(e){Xn(t,e);function t(r){var n=r.eventDispatcher;return e.call(this,{eventDispatcher:n,store:new Zn.LocalStorageStore({maxValues:100,key:"fs_optly_pending_events"})})||this}return t}(Jt);Te.LocalStoragePendingEventsDispatcher=ei;var J={},it=P&&P.__assign||function(){return it=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},it.apply(this,arguments)};Object.defineProperty(J,"__esModule",{value:!0});var ti="campaign_activated",ri="custom",Zt="$opt_bot_filtering";function ni(e){var t=[],r=e[0];return e.forEach(function(n){if(n.type==="conversion"||n.type==="impression"){var i=ot(n);n.type==="impression"?i.snapshots.push(er(n)):n.type==="conversion"&&i.snapshots.push(Qt(n)),t.push(i)}}),{client_name:r.context.clientName,client_version:r.context.clientVersion,account_id:r.context.accountId,project_id:r.context.projectId,revision:r.context.revision,anonymize_ip:r.context.anonymizeIP,enrich_decisions:!0,visitors:t}}J.makeBatchedEventV1=ni;function Qt(e){var t=it({},e.tags);delete t.revenue,delete t.value;var r={entity_id:e.event.id,key:e.event.key,timestamp:e.timestamp,uuid:e.uuid};return e.tags&&(r.tags=e.tags),e.value!=null&&(r.value=e.value),e.revenue!=null&&(r.revenue=e.revenue),{events:[r]}}function er(e){var t=e.layer,r=e.experiment,n=e.variation,i=t?t.id:null,o=r?r.id:null,a=n?n.id:null;return{decisions:[{campaign_id:i,experiment_id:o,variation_id:a}],events:[{entity_id:i,timestamp:e.timestamp,key:ti,uuid:e.uuid}]}}function ot(e){var t={snapshots:[],visitor_id:e.user.id,attributes:[]};return e.user.attributes.forEach(function(r){t.attributes.push({entity_id:r.entityId,key:r.key,type:"custom",value:r.value})}),typeof e.context.botFiltering=="boolean"&&t.attributes.push({entity_id:Zt,key:Zt,type:ri,value:e.context.botFiltering}),t}function ii(e){var t=ot(e);return t.snapshots.push(er(e)),{client_name:e.context.clientName,client_version:e.context.clientVersion,account_id:e.context.accountId,project_id:e.context.projectId,revision:e.context.revision,anonymize_ip:e.context.anonymizeIP,enrich_decisions:!0,visitors:[t]}}J.buildImpressionEventV1=ii;function oi(e){var t=ot(e);return t.snapshots.push(Qt(e)),{client_name:e.context.clientName,client_version:e.context.clientVersion,account_id:e.context.accountId,project_id:e.context.projectId,revision:e.context.revision,anonymize_ip:e.context.anonymizeIP,enrich_decisions:!0,visitors:[t]}}J.buildConversionEventV1=oi;var at={},ai=P&&P.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var o in i)i.hasOwnProperty(o)&&(n[o]=i[o])},e(t,r)};return function(t,r){e(t,r);function n(){this.constructor=t}t.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(at,"__esModule",{value:!0});var si=me,ui=J,li=function(e){ai(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t.prototype.formatEvents=function(r){return{url:"https://logx.optimizely.com/v1/events",httpVerb:"POST",params:ui.makeBatchedEventV1(r)}},t}(si.AbstractEventProcessor);at.LogTierV1EventProcessor=li,function(e){function t(r){for(var n in r)e.hasOwnProperty(n)||(e[n]=r[n])}Object.defineProperty(e,"__esModule",{value:!0}),t(Ie),t(me),t(Te),t(J),t(at)}(tt);var tr={exports:{}};(function(e){(function(){function t(i,o){for(var a=i.length,s=o^a,l=0,c;a>=4;)c=i.charCodeAt(l)&255|(i.charCodeAt(++l)&255)<<8|(i.charCodeAt(++l)&255)<<16|(i.charCodeAt(++l)&255)<<24,c=(c&65535)*1540483477+(((c>>>16)*1540483477&65535)<<16),c^=c>>>24,c=(c&65535)*1540483477+(((c>>>16)*1540483477&65535)<<16),s=(s&65535)*1540483477+(((s>>>16)*1540483477&65535)<<16)^c,a-=4,++l;switch(a){case 3:s^=(i.charCodeAt(l+2)&255)<<16;case 2:s^=(i.charCodeAt(l+1)&255)<<8;case 1:s^=i.charCodeAt(l)&255,s=(s&65535)*1540483477+(((s>>>16)*1540483477&65535)<<16)}return s^=s>>>13,s=(s&65535)*1540483477+(((s>>>16)*1540483477&65535)<<16),s^=s>>>15,s>>>0}function r(i,o){var a,s,l,c,f,d,p,g;for(a=i.length&3,s=i.length-a,l=o,f=3432918353,d=461845907,g=0;g<s;)p=i.charCodeAt(g)&255|(i.charCodeAt(++g)&255)<<8|(i.charCodeAt(++g)&255)<<16|(i.charCodeAt(++g)&255)<<24,++g,p=(p&65535)*f+(((p>>>16)*f&65535)<<16)&4294967295,p=p<<15|p>>>17,p=(p&65535)*d+(((p>>>16)*d&65535)<<16)&4294967295,l^=p,l=l<<13|l>>>19,c=(l&65535)*5+(((l>>>16)*5&65535)<<16)&4294967295,l=(c&65535)+27492+(((c>>>16)+58964&65535)<<16);switch(p=0,a){case 3:p^=(i.charCodeAt(g+2)&255)<<16;case 2:p^=(i.charCodeAt(g+1)&255)<<8;case 1:p^=i.charCodeAt(g)&255,p=(p&65535)*f+(((p>>>16)*f&65535)<<16)&4294967295,p=p<<15|p>>>17,p=(p&65535)*d+(((p>>>16)*d&65535)<<16)&4294967295,l^=p}return l^=i.length,l^=l>>>16,l=(l&65535)*2246822507+(((l>>>16)*2246822507&65535)<<16)&4294967295,l^=l>>>13,l=(l&65535)*3266489909+(((l>>>16)*3266489909&65535)<<16)&4294967295,l^=l>>>16,l>>>0}var n=r;n.v2=t,n.v3=r,e.exports=n})()})(tr);var ci=tr.exports,rr={},st={},ut={},G={};Object.defineProperty(G,"__esModule",{value:!0}),G.DEFAULT_UPDATE_INTERVAL=5*60*1e3,G.MIN_UPDATE_INTERVAL=1e3,G.DEFAULT_URL_TEMPLATE="https://cdn.optimizely.com/datafiles/%s.json",G.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT=[0,8,16,32,64,128,256,512],G.REQUEST_TIMEOUT_MS=60*1e3,Object.defineProperty(ut,"__esModule",{value:!0});var fi=G,di=S,pi=di.getLogger("DatafileManager"),Ei="GET",gi=4;function _i(e){var t=e.getAllResponseHeaders();if(t===null)return{};var r=t.split(`\r
`),n={};return r.forEach(function(i){var o=i.indexOf(": ");if(o>-1){var a=i.slice(0,o),s=i.slice(o+2);s.length>0&&(n[a]=s)}}),n}function hi(e,t){Object.keys(e).forEach(function(r){var n=e[r];t.setRequestHeader(r,n)})}function vi(e,t){var r=new XMLHttpRequest,n=new Promise(function(i,o){r.open(Ei,e,!0),hi(t,r),r.onreadystatechange=function(){if(r.readyState===gi){var a=r.status;if(a===0){o(new Error("Request error"));return}var s=_i(r),l={statusCode:r.status,body:r.responseText,headers:s};i(l)}},r.timeout=fi.REQUEST_TIMEOUT_MS,r.ontimeout=function(){pi.error("Request timed out")},r.send()});return{responsePromise:n,abort:function(){r.abort()}}}ut.makeGetRequest=vi;var lt={},ct={};Object.defineProperty(ct,"__esModule",{value:!0});var Ii=function(){function e(){this.listeners={},this.listenerId=1}return e.prototype.on=function(t,r){var n=this;this.listeners[t]||(this.listeners[t]={});var i=String(this.listenerId);return this.listenerId++,this.listeners[t][i]=r,function(){n.listeners[t]&&delete n.listeners[t][i]}},e.prototype.emit=function(t,r){var n=this.listeners[t];n&&Object.keys(n).forEach(function(i){var o=n[i];o(r)})},e.prototype.removeAllListeners=function(){this.listeners={}},e}();ct.default=Ii;var ft={};Object.defineProperty(ft,"__esModule",{value:!0});var dt=G;function mi(){return Math.round(Math.random()*1e3)}var yi=function(){function e(){this.errorCount=0}return e.prototype.getDelay=function(){if(this.errorCount===0)return 0;var t=dt.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT[Math.min(dt.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT.length-1,this.errorCount)];return t*1e3+mi()},e.prototype.countError=function(){this.errorCount<dt.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT.length-1&&this.errorCount++},e.prototype.reset=function(){this.errorCount=0},e}();ft.default=yi;var pt=P&&P.__assign||function(){return pt=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},pt.apply(this,arguments)},nr=P&&P.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(lt,"__esModule",{value:!0});var Ri=S,Ti=u,Oi=nr(ct),ae=G,Ni=nr(ft),F=Ri.getLogger("DatafileManager"),Ai="update";function Si(e){return e>=ae.MIN_UPDATE_INTERVAL}function ir(e){return e>=200&&e<400}var Li={get:function(){return Promise.resolve(null)},set:function(){return Promise.resolve()},contains:function(){return Promise.resolve(!1)},remove:function(){return Promise.resolve()}},Ui=function(){function e(t){var r=this,n=pt({},this.getConfigDefaults(),t),i=n.datafile,o=n.autoUpdate,a=o===void 0?!1:o,s=n.sdkKey,l=n.updateInterval,c=l===void 0?ae.DEFAULT_UPDATE_INTERVAL:l,f=n.urlTemplate,d=f===void 0?ae.DEFAULT_URL_TEMPLATE:f,p=n.cache,g=p===void 0?Li:p;this.cache=g,this.cacheKey="opt-datafile-"+s,this.isReadyPromiseSettled=!1,this.readyPromiseResolver=function(){},this.readyPromiseRejecter=function(){},this.readyPromise=new Promise(function(T,A){r.readyPromiseResolver=T,r.readyPromiseRejecter=A}),i?(this.currentDatafile=i,s||this.resolveReadyPromise()):this.currentDatafile=null,this.isStarted=!1,this.datafileUrl=Ti.sprintf(d,s),this.emitter=new Oi.default,this.autoUpdate=a,Si(c)?this.updateInterval=c:(F.warn("Invalid updateInterval %s, defaulting to %s",c,ae.DEFAULT_UPDATE_INTERVAL),this.updateInterval=ae.DEFAULT_UPDATE_INTERVAL),this.currentTimeout=null,this.currentRequest=null,this.backoffController=new Ni.default,this.syncOnCurrentRequestComplete=!1}return e.prototype.get=function(){return this.currentDatafile},e.prototype.start=function(){this.isStarted||(F.debug("Datafile manager started"),this.isStarted=!0,this.backoffController.reset(),this.setDatafileFromCacheIfAvailable(),this.syncDatafile())},e.prototype.stop=function(){return F.debug("Datafile manager stopped"),this.isStarted=!1,this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),this.emitter.removeAllListeners(),this.currentRequest&&(this.currentRequest.abort(),this.currentRequest=null),Promise.resolve()},e.prototype.onReady=function(){return this.readyPromise},e.prototype.on=function(t,r){return this.emitter.on(t,r)},e.prototype.onRequestRejected=function(t){!this.isStarted||(this.backoffController.countError(),t instanceof Error?F.error("Error fetching datafile: %s",t.message,t):typeof t=="string"?F.error("Error fetching datafile: %s",t):F.error("Error fetching datafile"))},e.prototype.onRequestResolved=function(t){if(!!this.isStarted){typeof t.statusCode<"u"&&ir(t.statusCode)?this.backoffController.reset():this.backoffController.countError(),this.trySavingLastModified(t.headers);var r=this.getNextDatafileFromResponse(t);if(r!==null)if(F.info("Updating datafile from response"),this.currentDatafile=r,this.cache.set(this.cacheKey,r),!this.isReadyPromiseSettled)this.resolveReadyPromise();else{var n={datafile:r};this.emitter.emit(Ai,n)}}},e.prototype.onRequestComplete=function(){!this.isStarted||(this.currentRequest=null,!this.isReadyPromiseSettled&&!this.autoUpdate&&this.rejectReadyPromise(new Error("Failed to become ready")),this.autoUpdate&&this.syncOnCurrentRequestComplete&&this.syncDatafile(),this.syncOnCurrentRequestComplete=!1)},e.prototype.syncDatafile=function(){var t=this,r={};this.lastResponseLastModified&&(r["if-modified-since"]=this.lastResponseLastModified),F.debug("Making datafile request to url %s with headers: %s",this.datafileUrl,function(){return JSON.stringify(r)}),this.currentRequest=this.makeGetRequest(this.datafileUrl,r);var n=function(){t.onRequestComplete()},i=function(a){t.onRequestResolved(a)},o=function(a){t.onRequestRejected(a)};this.currentRequest.responsePromise.then(i,o).then(n,n),this.autoUpdate&&this.scheduleNextUpdate()},e.prototype.resolveReadyPromise=function(){this.readyPromiseResolver(),this.isReadyPromiseSettled=!0},e.prototype.rejectReadyPromise=function(t){this.readyPromiseRejecter(t),this.isReadyPromiseSettled=!0},e.prototype.scheduleNextUpdate=function(){var t=this,r=this.backoffController.getDelay(),n=Math.max(r,this.updateInterval);F.debug("Scheduling sync in %s ms",n),this.currentTimeout=setTimeout(function(){t.currentRequest?t.syncOnCurrentRequestComplete=!0:t.syncDatafile()},n)},e.prototype.getNextDatafileFromResponse=function(t){return F.debug("Response status code: %s",t.statusCode),typeof t.statusCode>"u"||t.statusCode===304?null:ir(t.statusCode)?this.tryParsingBodyAsJSON(t.body):null},e.prototype.tryParsingBodyAsJSON=function(t){var r;try{r=JSON.parse(t)}catch(i){return F.error("Error parsing response body: %s",i.message,i),null}var n=null;return typeof r=="object"&&r!==null?n=r:F.error("Error parsing response body: was not an object"),n},e.prototype.trySavingLastModified=function(t){var r=t["last-modified"]||t["Last-Modified"];typeof r<"u"&&(this.lastResponseLastModified=r,F.debug("Saved last modified header value from response: %s",this.lastResponseLastModified))},e.prototype.setDatafileFromCacheIfAvailable=function(){var t=this;this.cache.get(this.cacheKey).then(function(r){t.isStarted&&!t.isReadyPromiseSettled&&r&&(F.debug("Using datafile from cache"),t.currentDatafile=r,t.resolveReadyPromise())})},e}();lt.default=Ui;var Di=P&&P.__extends||function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var o in i)i.hasOwnProperty(o)&&(n[o]=i[o])},e(t,r)};return function(t,r){e(t,r);function n(){this.constructor=t}t.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}(),bi=P&&P.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(st,"__esModule",{value:!0});var Ci=ut,Vi=bi(lt),Pi=function(e){Di(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t.prototype.makeGetRequest=function(r,n){return Ci.makeGetRequest(r,n)},t.prototype.getConfigDefaults=function(){return{autoUpdate:!1}},t}(Vi.default);st.default=Pi,Object.defineProperty(rr,"__esModule",{value:!0});var xi=st,Mi=rr.HttpPollingDatafileManager=xi.default,Fi=Math.pow(2,53),Et=function(e){return typeof e=="number"&&Math.abs(e)<=Fi},M=function(e){if(!e)return{};if(typeof Object.assign=="function")return Object.assign.apply(Object,arguments);for(var t=Object(e),r=1;r<arguments.length;r++){var n=arguments[r];if(n!=null)for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t},Oe=function(){return Math.round(new Date().getTime())},q=Et,k=function(e,t){return e?u.keyBy(e,function(r){return r[t]}):{}},Ne=function(){return Gt.v4()},Z=function(e){return typeof e=="number"},E={NOTSET:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4},R={CONDITION_EVALUATOR_ERROR:"%s: Error evaluating audience condition of type %s: %s",DATAFILE_AND_SDK_KEY_MISSING:"%s: You must provide at least one of sdkKey or datafile. Cannot start Optimizely",EXPERIMENT_KEY_NOT_IN_DATAFILE:"%s: Experiment key %s is not in datafile.",FEATURE_NOT_IN_DATAFILE:"%s: Feature key %s is not in datafile.",IMPROPERLY_FORMATTED_EXPERIMENT:"%s: Experiment key %s is improperly formatted.",INVALID_ATTRIBUTES:"%s: Provided attributes are in an invalid format.",INVALID_BUCKETING_ID:"%s: Unable to generate hash for bucketing ID %s: %s",INVALID_DATAFILE:"%s: Datafile is invalid - property %s: %s",INVALID_DATAFILE_MALFORMED:"%s: Datafile is invalid because it is malformed.",INVALID_JSON:"%s: JSON object is not valid.",INVALID_ERROR_HANDLER:'%s: Provided "errorHandler" is in an invalid format.',INVALID_EVENT_DISPATCHER:'%s: Provided "eventDispatcher" is in an invalid format.',INVALID_EVENT_TAGS:"%s: Provided event tags are in an invalid format.",INVALID_EXPERIMENT_KEY:"%s: Experiment key %s is not in datafile. It is either invalid, paused, or archived.",INVALID_EXPERIMENT_ID:"%s: Experiment ID %s is not in datafile.",INVALID_GROUP_ID:"%s: Group ID %s is not in datafile.",INVALID_LOGGER:'%s: Provided "logger" is in an invalid format.',INVALID_ROLLOUT_ID:"%s: Invalid rollout ID %s attached to feature %s",INVALID_USER_ID:"%s: Provided user ID is in an invalid format.",INVALID_USER_PROFILE_SERVICE:"%s: Provided user profile service instance is in an invalid format: %s.",NO_DATAFILE_SPECIFIED:"%s: No datafile specified. Cannot start optimizely.",NO_JSON_PROVIDED:"%s: No JSON object to validate against schema.",NO_VARIATION_FOR_EXPERIMENT_KEY:"%s: No variation key %s defined in datafile for experiment %s.",UNDEFINED_ATTRIBUTE:"%s: Provided attribute: %s has an undefined value.",UNRECOGNIZED_ATTRIBUTE:"%s: Unrecognized attribute %s provided. Pruning before sending event to Optimizely.",UNABLE_TO_CAST_VALUE:"%s: Unable to cast value %s to type %s, returning null.",USER_NOT_IN_FORCED_VARIATION:"%s: User %s is not in the forced variation map. Cannot remove their forced variation.",USER_PROFILE_LOOKUP_ERROR:'%s: Error while looking up user profile for user ID "%s": %s.',USER_PROFILE_SAVE_ERROR:'%s: Error while saving user profile for user ID "%s": %s.',VARIABLE_KEY_NOT_IN_DATAFILE:'%s: Variable with key "%s" associated with feature with key "%s" is not in datafile.',VARIATION_ID_NOT_IN_DATAFILE:"%s: No variation ID %s defined in datafile for experiment %s.",VARIATION_ID_NOT_IN_DATAFILE_NO_EXPERIMENT:"%s: Variation ID %s is not in the datafile.",INVALID_INPUT_FORMAT:"%s: Provided %s is in an invalid format.",INVALID_DATAFILE_VERSION:"%s: This version of the JavaScript SDK does not support the given datafile version: %s",INVALID_VARIATION_KEY:"%s: Provided variation key is in an invalid format."},I={ACTIVATE_USER:"%s: Activating user %s in experiment %s.",DISPATCH_CONVERSION_EVENT:"%s: Dispatching conversion event to URL %s with params %s.",DISPATCH_IMPRESSION_EVENT:"%s: Dispatching impression event to URL %s with params %s.",DEPRECATED_EVENT_VALUE:"%s: Event value is deprecated in %s call.",EVENT_KEY_NOT_FOUND:"%s: Event key %s is not in datafile.",EXPERIMENT_NOT_RUNNING:"%s: Experiment %s is not running.",FEATURE_ENABLED_FOR_USER:"%s: Feature %s is enabled for user %s.",FEATURE_NOT_ENABLED_FOR_USER:"%s: Feature %s is not enabled for user %s.",FEATURE_HAS_NO_EXPERIMENTS:"%s: Feature %s is not attached to any experiments.",FAILED_TO_PARSE_VALUE:'%s: Failed to parse event value "%s" from event tags.',FAILED_TO_PARSE_REVENUE:'%s: Failed to parse revenue value "%s" from event tags.',FORCED_BUCKETING_FAILED:"%s: Variation key %s is not in datafile. Not activating user %s.",INVALID_OBJECT:"%s: Optimizely object is not valid. Failing %s.",INVALID_CLIENT_ENGINE:"%s: Invalid client engine passed: %s. Defaulting to node-sdk.",INVALID_VARIATION_ID:"%s: Bucketed into an invalid variation ID. Returning null.",NOTIFICATION_LISTENER_EXCEPTION:"%s: Notification listener for (%s) threw exception: %s",NO_ROLLOUT_EXISTS:"%s: There is no rollout of feature %s.",NOT_ACTIVATING_USER:"%s: Not activating user %s for experiment %s.",NOT_TRACKING_USER:"%s: Not tracking user %s.",PARSED_REVENUE_VALUE:'%s: Parsed revenue value "%s" from event tags.',PARSED_NUMERIC_VALUE:'%s: Parsed event value "%s" from event tags.',RETURNING_STORED_VARIATION:'%s: Returning previously activated variation "%s" of experiment "%s" for user "%s" from user profile.',ROLLOUT_HAS_NO_EXPERIMENTS:"%s: Rollout of feature %s has no experiments",SAVED_VARIATION:'%s: Saved variation "%s" of experiment "%s" for user "%s".',SAVED_VARIATION_NOT_FOUND:"%s: User %s was previously bucketed into variation with ID %s for experiment %s, but no matching variation was found.",SHOULD_NOT_DISPATCH_ACTIVATE:'%s: Experiment %s is not in "Running" state. Not activating user.',SKIPPING_JSON_VALIDATION:"%s: Skipping JSON schema validation.",TRACK_EVENT:"%s: Tracking event %s for user %s.",USER_ASSIGNED_TO_VARIATION_BUCKET:"%s: Assigned variation bucket %s to user %s.",USER_ASSIGNED_TO_EXPERIMENT_BUCKET:"%s: Assigned experiment bucket %s to user %s.",USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP:"%s: User %s is in experiment %s of group %s.",USER_BUCKETED_INTO_TARGETING_RULE:"%s: User %s bucketed into targeting rule %s.",USER_IN_FEATURE_EXPERIMENT:"%s: User %s is in variation %s of experiment %s on the feature %s.",USER_IN_ROLLOUT:"%s: User %s is in rollout of feature %s.",USER_BUCKETED_INTO_EVERYONE_TARGETING_RULE:"%s: User %s bucketed into everyone targeting rule.",USER_NOT_BUCKETED_INTO_EVERYONE_TARGETING_RULE:"%s: User %s not bucketed into everyone targeting rule due to traffic allocation.",USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP:"%s: User %s is not in experiment %s of group %s.",USER_NOT_BUCKETED_INTO_ANY_EXPERIMENT_IN_GROUP:"%s: User %s is not in any experiment of group %s.",USER_NOT_BUCKETED_INTO_TARGETING_RULE:"%s User %s not bucketed into targeting rule %s due to traffic allocation. Trying everyone rule.",USER_NOT_IN_FEATURE_EXPERIMENT:"%s: User %s is not in any experiment on the feature %s.",USER_NOT_IN_ROLLOUT:"%s: User %s is not in rollout of feature %s.",USER_FORCED_IN_VARIATION:"%s: User %s is forced in variation %s.",USER_MAPPED_TO_FORCED_VARIATION:"%s: Set variation %s for experiment %s and user %s in the forced variation map.",USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE:"%s: User %s does not meet conditions for targeting rule %s.",USER_MEETS_CONDITIONS_FOR_TARGETING_RULE:"%s: User %s meets conditions for targeting rule %s.",USER_HAS_VARIATION:"%s: User %s is in variation %s of experiment %s.",USER_HAS_FORCED_VARIATION:"%s: Variation %s is mapped to experiment %s and user %s in the forced variation map.",USER_HAS_NO_VARIATION:"%s: User %s is in no variation of experiment %s.",USER_HAS_NO_FORCED_VARIATION:"%s: User %s is not in the forced variation map.",USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT:"%s: No experiment %s mapped to user %s in the forced variation map.",USER_NOT_IN_ANY_EXPERIMENT:"%s: User %s is not in any experiment of group %s.",USER_NOT_IN_EXPERIMENT:"%s: User %s does not meet conditions to be in experiment %s.",USER_RECEIVED_DEFAULT_VARIABLE_VALUE:'%s: User "%s" is not in any variation or rollout rule. Returning default value for variable "%s" of feature flag "%s".',FEATURE_NOT_ENABLED_RETURN_DEFAULT_VARIABLE_VALUE:'%s: Feature "%s" is not enabled for user %s. Returning default value for variable "%s".',VARIABLE_NOT_USED_RETURN_DEFAULT_VARIABLE_VALUE:'%s: Variable "%s" is not used in variation "%s". Returning default value.',USER_RECEIVED_VARIABLE_VALUE:'%s: Value for variable "%s" of feature flag "%s" is %s for user "%s"',VALID_DATAFILE:"%s: Datafile is valid.",VALID_USER_PROFILE_SERVICE:"%s: Valid user profile service provided.",VARIATION_REMOVED_FOR_USER:"%s: Variation mapped to experiment %s has been removed for user %s.",VARIABLE_REQUESTED_WITH_WRONG_TYPE:'%s: Requested variable type "%s", but variable is of type "%s". Use correct API to retrieve value. Returning None.',VALID_BUCKETING_ID:'%s: BucketingId is valid: "%s"',BUCKETING_ID_NOT_STRING:"%s: BucketingID attribute is not a string. Defaulted to userId",EVALUATING_AUDIENCE:'%s: Starting to evaluate audience "%s" with conditions: %s.',EVALUATING_AUDIENCES_COMBINED:'%s: Evaluating audiences for experiment "%s": %s.',AUDIENCE_EVALUATION_RESULT:'%s: Audience "%s" evaluated to %s.',AUDIENCE_EVALUATION_RESULT_COMBINED:"%s: Audiences for experiment %s collectively evaluated to %s.",MISSING_ATTRIBUTE_VALUE:'%s: Audience condition %s evaluated to UNKNOWN because no value was passed for user attribute "%s".',UNEXPECTED_CONDITION_VALUE:"%s: Audience condition %s evaluated to UNKNOWN because the condition value is not supported.",UNEXPECTED_TYPE:'%s: Audience condition %s evaluated to UNKNOWN because a value of type "%s" was passed for user attribute "%s".',UNEXPECTED_TYPE_NULL:'%s: Audience condition %s evaluated to UNKNOWN because a null value was passed for user attribute "%s".',UNKNOWN_CONDITION_TYPE:"%s: Audience condition %s has an unknown condition type. You may need to upgrade to a newer release of the Optimizely SDK.",UNKNOWN_MATCH_TYPE:"%s: Audience condition %s uses an unknown match type. You may need to upgrade to a newer release of the Optimizely SDK.",UPDATED_OPTIMIZELY_CONFIG:"%s: Updated Optimizely config to revision %s (project id %s)",OUT_OF_BOUNDS:'%s: Audience condition %s evaluated to UNKNOWN because the number value for user attribute "%s" is not in the range [-2^53, +2^53].',UNABLE_TO_ATTACH_UNLOAD:'%s: unable to bind optimizely.close() to page unload event: "%s"'},gt={REVENUE:"revenue",VALUE:"value"},Ae=u.NOTIFICATION_TYPES,Se={BOOLEAN:"boolean",DOUBLE:"double",INTEGER:"integer",STRING:"string"},Le={V2:"2",V3:"3",V4:"4"},O={LOG_LEVEL:E,ERROR_MESSAGES:R,LOG_MESSAGES:I,RESERVED_EVENT_KEYWORDS:gt,CONTROL_ATTRIBUTES:{BOT_FILTERING:"$opt_bot_filtering",BUCKETING_ID:"$opt_bucketing_id",STICKY_BUCKETING_KEY:"$opt_experiment_bucket_map",USER_AGENT:"$opt_user_agent"},JAVASCRIPT_CLIENT_ENGINE:"javascript-sdk",NODE_CLIENT_ENGINE:"node-sdk",REACT_CLIENT_ENGINE:"react-sdk",NODE_CLIENT_VERSION:"4.0.0",VALID_CLIENT_ENGINES:["node-sdk","react-sdk","javascript-sdk"],NOTIFICATION_TYPES:Ae,DECISION_NOTIFICATION_TYPES:{AB_TEST:"ab-test",FEATURE:"feature",FEATURE_TEST:"feature-test",FEATURE_VARIABLE:"feature-variable"},DECISION_SOURCES:{FEATURE_TEST:"feature-test",ROLLOUT:"rollout"},FEATURE_VARIABLE_TYPES:Se,DATAFILE_VERSIONS:Le},Q="CONFIG_VALIDATOR",ki=[Le.V2,Le.V3,Le.V4],wi=function(e){if(e.errorHandler&&typeof e.errorHandler.handleError!="function")throw new Error(u.sprintf(R.INVALID_ERROR_HANDLER,Q));if(e.eventDispatcher&&typeof e.eventDispatcher.dispatchEvent!="function")throw new Error(u.sprintf(R.INVALID_EVENT_DISPATCHER,Q));if(e.logger&&typeof e.logger.log!="function")throw new Error(u.sprintf(R.INVALID_LOGGER,Q));return!0},or=function(e){if(!e)throw new Error(u.sprintf(R.NO_DATAFILE_SPECIFIED,Q));if(typeof e=="string"||e instanceof String)try{e=JSON.parse(e)}catch{throw new Error(u.sprintf(R.INVALID_DATAFILE_MALFORMED,Q))}if(ki.indexOf(e.version)===-1)throw new Error(u.sprintf(R.INVALID_DATAFILE_VERSION,Q,e.version));return!0},Bi={handleError:function(){}},Gi=function(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")},ar={dispatchEvent:function(e,t){var r,n=e.url,i=e.params;e.httpVerb==="POST"?((r=new XMLHttpRequest).open("POST",n,!0),r.setRequestHeader("Content-Type","application/json"),r.onreadystatechange=function(){if(r.readyState===4&&t&&typeof t=="function")try{t(i)}catch{}},r.send(JSON.stringify(i))):(n+="?wxhr=true",i&&(n+="&"+Gi(i)),(r=new XMLHttpRequest).open("GET",n,!0),r.onreadystatechange=function(){if(r.readyState===4&&t&&typeof t=="function")try{t()}catch{}},r.send())}};function sr(){}sr.prototype.log=function(){};var ur={createLogger:function(e){return new S.ConsoleLogHandler(e)},createNoOpLogger:function(){return new sr}},ji=function(e){if(typeof e!="object"||Array.isArray(e)||e===null)throw new Error(u.sprintf(R.INVALID_ATTRIBUTES,"ATTRIBUTES_VALIDATOR"));return Object.keys(e).forEach(function(t){if(e[t]===void 0)throw new Error(u.sprintf(R.UNDEFINED_ATTRIBUTE,"ATTRIBUTES_VALIDATOR",t))}),!0},lr=function(e,t){return typeof e=="string"&&(typeof t=="string"||typeof t=="boolean"||Z(t)&&q(t))},Ki=Math.pow(2,32),Ue={bucket:function(e){var t=e.experimentKeyMap[e.experimentKey].groupId;if(t){var r=e.groupIdMap[t];if(!r)throw new Error(u.sprintf(R.INVALID_GROUP_ID,"BUCKETER",t));if(r.policy==="random"){var n=this.bucketUserIntoExperiment(r,e.bucketingId,e.userId,e.logger);if(n===null){var i=u.sprintf(I.USER_NOT_IN_ANY_EXPERIMENT,"BUCKETER",e.userId,t);return e.logger.log(E.INFO,i),null}if(n!==e.experimentId){var o=u.sprintf(I.USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",e.userId,e.experimentKey,t);return e.logger.log(E.INFO,o),null}var a=u.sprintf(I.USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",e.userId,e.experimentKey,t);e.logger.log(E.INFO,a)}}var s=u.sprintf("%s%s",e.bucketingId,e.experimentId),l=this._generateBucketValue(s),c=u.sprintf(I.USER_ASSIGNED_TO_VARIATION_BUCKET,"BUCKETER",l,e.userId);e.logger.log(E.DEBUG,c);var f=this._findBucket(l,e.trafficAllocationConfig);if(f){if(!e.variationIdMap.hasOwnProperty(f)){var d=u.sprintf(I.INVALID_VARIATION_ID,"BUCKETER");return e.logger.log(E.WARNING,d),null}var p=e.variationIdMap[f].key,g=u.sprintf(I.USER_HAS_VARIATION,"BUCKETER",e.userId,p,e.experimentKey);e.logger.log(E.INFO,g)}else{var T=u.sprintf(I.USER_HAS_NO_VARIATION,"BUCKETER",e.userId,e.experimentKey);e.logger.log(E.DEBUG,T)}return f},bucketUserIntoExperiment:function(e,t,r,n){var i=u.sprintf("%s%s",t,e.id),o=this._generateBucketValue(i);n.log(E.DEBUG,u.sprintf(I.USER_ASSIGNED_TO_EXPERIMENT_BUCKET,"BUCKETER",o,r));var a=e.trafficAllocation;return this._findBucket(o,a)},_findBucket:function(e,t){for(var r=0;r<t.length;r++)if(e<t[r].endOfRange)return t[r].entityId;return null},_generateBucketValue:function(e){try{var t=ci.v3(e,1);return parseInt(1e4*(t/Ki),10)}catch(r){throw new Error(u.sprintf(R.INVALID_BUCKETING_ID,"BUCKETER",e,r.message))}}},C="PROJECT_CONFIG",cr=function(e,t){return e.experimentFeatureMap.hasOwnProperty(t)},m={createProjectConfig:function(e){var t=function(r){var n=M({},r);return n.audiences=(r.audiences||[]).map(function(i){return M({},i)}),n.experiments=(r.experiments||[]).map(function(i){return M({},i)}),n.featureFlags=(r.featureFlags||[]).map(function(i){return M({},i)}),n.groups=(r.groups||[]).map(function(i){var o=M({},i);return o.experiments=(i.experiments||[]).map(function(a){return M({},a)}),o}),n.rollouts=(r.rollouts||[]).map(function(i){var o=M({},i);return o.experiments=(i.experiments||[]).map(function(a){return M({},a)}),o}),n}(e);return(t.audiences||[]).forEach(function(r){r.conditions=JSON.parse(r.conditions)}),t.audiencesById=k(t.audiences,"id"),M(t.audiencesById,k(t.typedAudiences,"id")),t.attributeKeyMap=k(t.attributes,"key"),t.eventKeyMap=k(t.events,"key"),t.groupIdMap=k(t.groups,"id"),Object.keys(t.groupIdMap||{}).forEach(function(r){(t.groupIdMap[r].experiments||[]).forEach(function(n){t.experiments.push(M(n,{groupId:r}))})}),t.rolloutIdMap=k(t.rollouts||[],"id"),u.objectValues(t.rolloutIdMap||{}).forEach(function(r){(r.experiments||[]).forEach(function(n){t.experiments.push(n),n.variationKeyMap=k(n.variations,"key")})}),t.experimentKeyMap=k(t.experiments,"key"),t.experimentIdMap=k(t.experiments,"id"),t.variationIdMap={},t.variationVariableUsageMap={},(t.experiments||[]).forEach(function(r){r.variationKeyMap=k(r.variations,"key"),M(t.variationIdMap,k(r.variations,"id")),u.objectValues(r.variationKeyMap||{}).forEach(function(n){n.variables&&(t.variationVariableUsageMap[n.id]=k(n.variables,"id"))})}),t.experimentFeatureMap={},t.featureKeyMap=k(t.featureFlags||[],"key"),u.objectValues(t.featureKeyMap||{}).forEach(function(r){r.variableKeyMap=k(r.variables,"key"),(r.experimentIds||[]).forEach(function(n){t.experimentFeatureMap[n]?t.experimentFeatureMap[n].push(r.id):t.experimentFeatureMap[n]=[r.id];var i=t.experimentIdMap[n];i.groupId&&!r.groupId&&(r.groupId=i.groupId)})}),t},getExperimentId:function(e,t){var r=e.experimentKeyMap[t];if(!r)throw new Error(u.sprintf(R.INVALID_EXPERIMENT_KEY,C,t));return r.id},getLayerId:function(e,t){var r=e.experimentIdMap[t];if(!r)throw new Error(u.sprintf(R.INVALID_EXPERIMENT_ID,C,t));return r.layerId},getAttributeId:function(e,t,r){var n=e.attributeKeyMap[t],i=t.indexOf("$opt_")===0;return n?(i&&r.log(E.WARN,u.sprintf("Attribute %s unexpectedly has reserved prefix %s; using attribute ID instead of reserved attribute name.",t,"$opt_")),n.id):i?t:(r.log(E.DEBUG,u.sprintf(R.UNRECOGNIZED_ATTRIBUTE,C,t)),null)},getEventId:function(e,t){var r=e.eventKeyMap[t];return r?r.id:null},getExperimentStatus:function(e,t){var r=e.experimentKeyMap[t];if(!r)throw new Error(u.sprintf(R.INVALID_EXPERIMENT_KEY,C,t));return r.status},isActive:function(e,t){return this.getExperimentStatus(e,t)==="Running"},isRunning:function(e,t){return this.getExperimentStatus(e,t)==="Running"},getExperimentAudienceConditions:function(e,t){var r=e.experimentKeyMap[t];if(!r)throw new Error(u.sprintf(R.INVALID_EXPERIMENT_KEY,C,t));return r.audienceConditions||r.audienceIds},getVariationKeyFromId:function(e,t){return e.variationIdMap.hasOwnProperty(t)?e.variationIdMap[t].key:null},getVariationIdFromExperimentAndVariationKey:function(e,t,r){var n=e.experimentKeyMap[t];return n.variationKeyMap.hasOwnProperty(r)?n.variationKeyMap[r].id:null},getExperimentFromKey:function(e,t){if(e.experimentKeyMap.hasOwnProperty(t)){var r=e.experimentKeyMap[t];if(r)return r}throw new Error(u.sprintf(R.EXPERIMENT_KEY_NOT_IN_DATAFILE,C,t))},getTrafficAllocation:function(e,t){var r=e.experimentKeyMap[t];if(!r)throw new Error(u.sprintf(R.INVALID_EXPERIMENT_KEY,C,t));return r.trafficAllocation},getExperimentFromId:function(e,t,r){if(e.experimentIdMap.hasOwnProperty(t)){var n=e.experimentIdMap[t];if(n)return n}return r.log(E.ERROR,u.sprintf(R.INVALID_EXPERIMENT_ID,C,t)),null},getFeatureFromKey:function(e,t,r){if(e.featureKeyMap.hasOwnProperty(t)){var n=e.featureKeyMap[t];if(n)return n}return r.log(E.ERROR,u.sprintf(R.FEATURE_NOT_IN_DATAFILE,C,t)),null},getVariableForFeature:function(e,t,r,n){var i=e.featureKeyMap[t];if(!i)return n.log(E.ERROR,u.sprintf(R.FEATURE_NOT_IN_DATAFILE,C,t)),null;var o=i.variableKeyMap[r];return o||(n.log(E.ERROR,u.sprintf(R.VARIABLE_KEY_NOT_IN_DATAFILE,C,r,t)),null)},getVariableValueForVariation:function(e,t,r,n){if(!t||!r)return null;if(!e.variationVariableUsageMap.hasOwnProperty(r.id))return n.log(E.ERROR,u.sprintf(R.VARIATION_ID_NOT_IN_DATAFILE_NO_EXPERIMENT,C,r.id)),null;var i=e.variationVariableUsageMap[r.id][t.id];return i?i.value:null},getTypeCastValue:function(e,t,r){var n;switch(t){case Se.BOOLEAN:e!=="true"&&e!=="false"?(r.log(E.ERROR,u.sprintf(R.UNABLE_TO_CAST_VALUE,C,e,t)),n=null):n=e==="true";break;case Se.INTEGER:n=parseInt(e,10),isNaN(n)&&(r.log(E.ERROR,u.sprintf(R.UNABLE_TO_CAST_VALUE,C,e,t)),n=null);break;case Se.DOUBLE:n=parseFloat(e),isNaN(n)&&(r.log(E.ERROR,u.sprintf(R.UNABLE_TO_CAST_VALUE,C,e,t)),n=null);break;default:n=e}return n},getAudiencesById:function(e){return e.audiencesById},eventWithKeyExists:function(e,t){return e.eventKeyMap.hasOwnProperty(t)},isFeatureExperiment:cr,tryCreatingProjectConfig:function(e){return or(e.datafile),e.jsonSchemaValidator?(e.jsonSchemaValidator.validate(e.datafile),e.logger.log(E.INFO,u.sprintf(I.VALID_DATAFILE,C))):e.logger.log(E.INFO,u.sprintf(I.SKIPPING_JSON_VALIDATION,C)),this.createProjectConfig(e.datafile)}},Hi=["and","or","not"],De=function(e,t){if(Array.isArray(e)){var r=e[0],n=e.slice(1);switch(Hi.indexOf(r)===-1&&(r="or",n=e),r){case"and":return function(i,o){for(var a=!1,s=0;s<i.length;s++){var l=De(i[s],o);if(l===!1)return!1;l===null&&(a=!0)}return!a||null}(n,t);case"not":return function(i,o){if(i.length>0){var a=De(i[0],o);return a===null?null:!a}return null}(n,t);default:return function(i,o){for(var a=!1,s=0;s<i.length;s++){var l=De(i[s],o);if(l===!0)return!0;l===null&&(a=!0)}return!!a&&null}(n,t)}}return t(e)},fr=De,V="CUSTOM_ATTRIBUTE_CONDITION_EVALUATOR",qi=["exact","exists","gt","lt","substring"],ee={};ee.exact=pr,ee.exists=function(e,t){var r=t[e.name];return r!=null},ee.gt=function(e,t,r){var n=e.name,i=t[n],o=typeof i,a=e.value;return q(a)?i===null?(r.log(E.DEBUG,u.sprintf(I.UNEXPECTED_TYPE_NULL,V,JSON.stringify(e),n)),null):Z(i)?q(i)?i>a:(r.log(E.WARNING,u.sprintf(I.OUT_OF_BOUNDS,V,JSON.stringify(e),n)),null):(r.log(E.WARNING,u.sprintf(I.UNEXPECTED_TYPE,V,JSON.stringify(e),o,n)),null):(r.log(E.WARNING,u.sprintf(I.UNEXPECTED_CONDITION_VALUE,V,JSON.stringify(e))),null)},ee.lt=function(e,t,r){var n=e.name,i=t[e.name],o=typeof i,a=e.value;return q(a)?i===null?(r.log(E.DEBUG,u.sprintf(I.UNEXPECTED_TYPE_NULL,V,JSON.stringify(e),n)),null):Z(i)?q(i)?i<a:(r.log(E.WARNING,u.sprintf(I.OUT_OF_BOUNDS,V,JSON.stringify(e),n)),null):(r.log(E.WARNING,u.sprintf(I.UNEXPECTED_TYPE,V,JSON.stringify(e),o,n)),null):(r.log(E.WARNING,u.sprintf(I.UNEXPECTED_CONDITION_VALUE,V,JSON.stringify(e))),null)},ee.substring=function(e,t,r){var n=e.name,i=t[e.name],o=typeof i,a=e.value;return typeof a!="string"?(r.log(E.WARNING,u.sprintf(I.UNEXPECTED_CONDITION_VALUE,V,JSON.stringify(e))),null):i===null?(r.log(E.DEBUG,u.sprintf(I.UNEXPECTED_TYPE_NULL,V,JSON.stringify(e),n)),null):typeof i!="string"?(r.log(E.WARNING,u.sprintf(I.UNEXPECTED_TYPE,V,JSON.stringify(e),o,n)),null):i.indexOf(a)!==-1};function dr(e){return typeof e=="string"||typeof e=="boolean"||Z(e)}function pr(e,t,r){var n=e.value,i=typeof n,o=e.name,a=t[o],s=typeof a;return!dr(n)||Z(n)&&!q(n)?(r.log(E.WARNING,u.sprintf(I.UNEXPECTED_CONDITION_VALUE,V,JSON.stringify(e))),null):a===null?(r.log(E.DEBUG,u.sprintf(I.UNEXPECTED_TYPE_NULL,V,JSON.stringify(e),o)),null):dr(a)&&i===s?Z(a)&&!q(a)?(r.log(E.WARNING,u.sprintf(I.OUT_OF_BOUNDS,V,JSON.stringify(e),o)),null):n===a:(r.log(E.WARNING,u.sprintf(I.UNEXPECTED_TYPE,V,JSON.stringify(e),s,o)),null)}var Yi={evaluate:function(e,t,r){var n=e.match;if(n!==void 0&&qi.indexOf(n)===-1)return r.log(E.WARNING,u.sprintf(I.UNKNOWN_MATCH_TYPE,V,JSON.stringify(e))),null;var i=e.name;return t.hasOwnProperty(i)||n=="exists"?(ee[n]||pr)(e,t,r):(r.log(E.DEBUG,u.sprintf(I.MISSING_ATTRIBUTE_VALUE,V,JSON.stringify(e),i)),null)}},se=S.getLogger();function _t(e){this.typeToEvaluatorMap=M({},e,{custom_attribute:Yi})}_t.prototype.evaluate=function(e,t,r){if(!e||e.length===0)return!0;r||(r={});var n=function(i){var o=t[i];if(o){se.log(E.DEBUG,u.sprintf(I.EVALUATING_AUDIENCE,"AUDIENCE_EVALUATOR",i,JSON.stringify(o.conditions)));var a=fr(o.conditions,this.evaluateConditionWithUserAttributes.bind(this,r)),s=a===null?"UNKNOWN":a.toString().toUpperCase();return se.log(E.INFO,u.sprintf(I.AUDIENCE_EVALUATION_RESULT,"AUDIENCE_EVALUATOR",i,s)),a}return null}.bind(this);return fr(e,n)||!1},_t.prototype.evaluateConditionWithUserAttributes=function(e,t){var r=this.typeToEvaluatorMap[t.type];if(!r)return se.log(E.WARNING,u.sprintf(I.UNKNOWN_CONDITION_TYPE,"AUDIENCE_EVALUATOR",JSON.stringify(t))),null;try{return r.evaluate(t,e,se)}catch(n){se.log(E.ERROR,u.sprintf(R.CONDITION_EVALUATOR_ERROR,"AUDIENCE_EVALUATOR",t.type,n.message))}return null};var Er=function(e){return typeof e=="string"&&e!==""},v="DECISION_SERVICE",j=O.ERROR_MESSAGES,_=O.LOG_LEVEL,y=O.LOG_MESSAGES,W=O.DECISION_SOURCES;function D(e){this.audienceEvaluator=new _t(e.UNSTABLE_conditionEvaluators),this.forcedVariationMap={},this.logger=e.logger,this.userProfileService=e.userProfileService||null}D.prototype.getVariation=function(e,t,r,n){var i=this._getBucketingId(r,n);if(!this.__checkIfExperimentIsActive(e,t))return null;var o=e.experimentKeyMap[t],a=this.getForcedVariation(e,t,r);if(a)return a;var s=this.__getWhitelistedVariation(o,r);if(s)return s.key;var l=this.__resolveExperimentBucketMap(r,n);if(s=this.__getStoredVariation(e,o,r,l))return this.logger.log(_.INFO,u.sprintf(y.RETURNING_STORED_VARIATION,v,s.key,t,r)),s.key;if(!this.__checkIfUserIsInAudience(e,t,r,n))return null;var c=this.__buildBucketerParams(e,t,i,r),f=Ue.bucket(c);return(s=e.variationIdMap[f])?(this.__saveUserProfile(o,s,r,l),s.key):null},D.prototype.__resolveExperimentBucketMap=function(e,t){t=t||{};var r=this.__getUserProfile(e)||{},n=t[O.CONTROL_ATTRIBUTES.STICKY_BUCKETING_KEY];return M({},r.experiment_bucket_map,n)},D.prototype.__checkIfExperimentIsActive=function(e,t){if(!m.isActive(e,t)){var r=u.sprintf(y.EXPERIMENT_NOT_RUNNING,v,t);return this.logger.log(_.INFO,r),!1}return!0},D.prototype.__getWhitelistedVariation=function(e,t){if(e.forcedVariations&&e.forcedVariations.hasOwnProperty(t)){var r=e.forcedVariations[t];if(e.variationKeyMap.hasOwnProperty(r)){var n=u.sprintf(y.USER_FORCED_IN_VARIATION,v,t,r);return this.logger.log(_.INFO,n),e.variationKeyMap[r]}var i=u.sprintf(y.FORCED_BUCKETING_FAILED,v,r,t);return this.logger.log(_.ERROR,i),null}return null},D.prototype.__checkIfUserIsInAudience=function(e,t,r,n){var i=m.getExperimentAudienceConditions(e,t),o=m.getAudiencesById(e);this.logger.log(_.DEBUG,u.sprintf(y.EVALUATING_AUDIENCES_COMBINED,v,t,JSON.stringify(i)));var a=this.audienceEvaluator.evaluate(i,o,n);if(this.logger.log(_.INFO,u.sprintf(y.AUDIENCE_EVALUATION_RESULT_COMBINED,v,t,a.toString().toUpperCase())),!a){var s=u.sprintf(y.USER_NOT_IN_EXPERIMENT,v,r,t);return this.logger.log(_.INFO,s),!1}return!0},D.prototype.__buildBucketerParams=function(e,t,r,n){var i={};return i.experimentKey=t,i.experimentId=m.getExperimentId(e,t),i.userId=n,i.trafficAllocationConfig=m.getTrafficAllocation(e,t),i.experimentKeyMap=e.experimentKeyMap,i.groupIdMap=e.groupIdMap,i.variationIdMap=e.variationIdMap,i.logger=this.logger,i.bucketingId=r,i},D.prototype.__getStoredVariation=function(e,t,r,n){if(n.hasOwnProperty(t.id)){var i=n[t.id],o=i.variation_id;if(e.variationIdMap.hasOwnProperty(o))return e.variationIdMap[i.variation_id];this.logger.log(_.INFO,u.sprintf(y.SAVED_VARIATION_NOT_FOUND,v,r,o,t.key))}return null},D.prototype.__getUserProfile=function(e){var t={user_id:e,experiment_bucket_map:{}};if(!this.userProfileService)return t;try{return this.userProfileService.lookup(e)}catch(r){this.logger.log(_.ERROR,u.sprintf(j.USER_PROFILE_LOOKUP_ERROR,v,e,r.message))}},D.prototype.__saveUserProfile=function(e,t,r,n){if(this.userProfileService)try{n[e.id]={variation_id:t.id},this.userProfileService.save({user_id:r,experiment_bucket_map:n}),this.logger.log(_.INFO,u.sprintf(y.SAVED_VARIATION,v,t.key,e.key,r))}catch(i){this.logger.log(_.ERROR,u.sprintf(j.USER_PROFILE_SAVE_ERROR,v,r,i.message))}},D.prototype.getVariationForFeature=function(e,t,r,n){var i=this._getVariationForFeatureExperiment(e,t,r,n);if(i.variation!==null)return this.logger.log(_.DEBUG,u.sprintf(y.USER_IN_FEATURE_EXPERIMENT,v,r,i.variation.key,i.experiment.key,t.key)),i;this.logger.log(_.DEBUG,u.sprintf(y.USER_NOT_IN_FEATURE_EXPERIMENT,v,r,t.key));var o=this._getVariationForRollout(e,t,r,n);return o.variation!==null?(this.logger.log(_.DEBUG,u.sprintf(y.USER_IN_ROLLOUT,v,r,t.key)),o):(this.logger.log(_.DEBUG,u.sprintf(y.USER_NOT_IN_ROLLOUT,v,r,t.key)),o)},D.prototype._getVariationForFeatureExperiment=function(e,t,r,n){var i=null,o=null;if(t.hasOwnProperty("groupId")){var a=e.groupIdMap[t.groupId];a&&(i=this._getExperimentInGroup(e,a,r))&&t.experimentIds.indexOf(i.id)!==-1&&(o=this.getVariation(e,i.key,r,n))}else t.experimentIds.length>0?(i=m.getExperimentFromId(e,t.experimentIds[0],this.logger))&&(o=this.getVariation(e,i.key,r,n)):this.logger.log(_.DEBUG,u.sprintf(y.FEATURE_HAS_NO_EXPERIMENTS,v,t.key));var s=null;return o!==null&&i!==null&&(s=i.variationKeyMap[o]),{experiment:i,variation:s,decisionSource:W.FEATURE_TEST}},D.prototype._getExperimentInGroup=function(e,t,r){var n=Ue.bucketUserIntoExperiment(t,r,r,this.logger);if(n){this.logger.log(_.INFO,u.sprintf(y.USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP,v,r,n,t.id));var i=m.getExperimentFromId(e,n,this.logger);if(i)return i}return this.logger.log(_.INFO,u.sprintf(y.USER_NOT_BUCKETED_INTO_ANY_EXPERIMENT_IN_GROUP,v,r,t.id)),null},D.prototype._getVariationForRollout=function(e,t,r,n){if(!t.rolloutId)return this.logger.log(_.DEBUG,u.sprintf(y.NO_ROLLOUT_EXISTS,v,t.key)),{experiment:null,variation:null,decisionSource:W.ROLLOUT};var i=e.rolloutIdMap[t.rolloutId];if(!i)return this.logger.log(_.ERROR,u.sprintf(j.INVALID_ROLLOUT_ID,v,t.rolloutId,t.key)),{experiment:null,variation:null,decisionSource:W.ROLLOUT};if(i.experiments.length===0)return this.logger.log(_.ERROR,u.sprintf(y.ROLLOUT_HAS_NO_EXPERIMENTS,v,t.rolloutId)),{experiment:null,variation:null,decisionSource:W.ROLLOUT};var o,a,s,l,c,f=this._getBucketingId(r,n),d=i.experiments.length-1;for(o=0;o<d;o++){if(a=e.experimentKeyMap[i.experiments[o].key],this.__checkIfUserIsInAudience(e,a.key,r,n)){if(this.logger.log(_.DEBUG,u.sprintf(y.USER_MEETS_CONDITIONS_FOR_TARGETING_RULE,v,r,o+1)),s=this.__buildBucketerParams(e,a.key,f,r),l=Ue.bucket(s),c=e.variationIdMap[l])return this.logger.log(_.DEBUG,u.sprintf(y.USER_BUCKETED_INTO_TARGETING_RULE,v,r,o+1)),{experiment:a,variation:c,decisionSource:W.ROLLOUT};this.logger.log(_.DEBUG,u.sprintf(y.USER_NOT_BUCKETED_INTO_TARGETING_RULE,v,r,o+1));break}this.logger.log(_.DEBUG,u.sprintf(y.USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE,v,r,o+1))}var p=e.experimentKeyMap[i.experiments[d].key];if(this.__checkIfUserIsInAudience(e,p.key,r,n)){if(s=this.__buildBucketerParams(e,p.key,f,r),l=Ue.bucket(s),c=e.variationIdMap[l])return this.logger.log(_.DEBUG,u.sprintf(y.USER_BUCKETED_INTO_EVERYONE_TARGETING_RULE,v,r)),{experiment:p,variation:c,decisionSource:W.ROLLOUT};this.logger.log(_.DEBUG,u.sprintf(y.USER_NOT_BUCKETED_INTO_EVERYONE_TARGETING_RULE,v,r))}return{experiment:null,variation:null,decisionSource:W.ROLLOUT}},D.prototype._getBucketingId=function(e,t){var r=e;return t!=null&&typeof t=="object"&&t.hasOwnProperty(O.CONTROL_ATTRIBUTES.BUCKETING_ID)&&(typeof t[O.CONTROL_ATTRIBUTES.BUCKETING_ID]=="string"?(r=t[O.CONTROL_ATTRIBUTES.BUCKETING_ID],this.logger.log(_.DEBUG,u.sprintf(y.VALID_BUCKETING_ID,v,r))):this.logger.log(_.WARNING,u.sprintf(y.BUCKETING_ID_NOT_STRING,v))),r},D.prototype.removeForcedVariation=function(e,t,r){if(!e)throw new Error(u.sprintf(j.INVALID_USER_ID,v));if(!this.forcedVariationMap.hasOwnProperty(e))throw new Error(u.sprintf(j.USER_NOT_IN_FORCED_VARIATION,v,e));delete this.forcedVariationMap[e][t],this.logger.log(_.DEBUG,u.sprintf(y.VARIATION_REMOVED_FOR_USER,v,r,e))},D.prototype.__setInForcedVariationMap=function(e,t,r){this.forcedVariationMap.hasOwnProperty(e)||(this.forcedVariationMap[e]={}),this.forcedVariationMap[e][t]=r,this.logger.log(_.DEBUG,u.sprintf(y.USER_MAPPED_TO_FORCED_VARIATION,v,r,t,e))},D.prototype.getForcedVariation=function(e,t,r){var n,i=this.forcedVariationMap[r];if(!i)return this.logger.log(_.DEBUG,u.sprintf(y.USER_HAS_NO_FORCED_VARIATION,v,r)),null;try{var o=m.getExperimentFromKey(e,t);if(!o.hasOwnProperty("id"))return this.logger.log(_.ERROR,u.sprintf(j.IMPROPERLY_FORMATTED_EXPERIMENT,v,t)),null;n=o.id}catch(l){return this.logger.log(_.ERROR,l.message),null}var a=i[n];if(!a)return this.logger.log(_.DEBUG,u.sprintf(y.USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT,v,t,r)),null;var s=m.getVariationKeyFromId(e,a);return s?this.logger.log(_.DEBUG,u.sprintf(y.USER_HAS_FORCED_VARIATION,v,s,t,r)):this.logger.log(_.DEBUG,u.sprintf(y.USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT,v,t,r)),s},D.prototype.setForcedVariation=function(e,t,r,n){if(n!=null&&!Er(n))return this.logger.log(_.ERROR,u.sprintf(j.INVALID_VARIATION_KEY,v)),!1;var i;try{var o=m.getExperimentFromKey(e,t);if(!o.hasOwnProperty("id"))return this.logger.log(_.ERROR,u.sprintf(j.IMPROPERLY_FORMATTED_EXPERIMENT,v,t)),!1;i=o.id}catch(s){return this.logger.log(_.ERROR,s.message),!1}if(n==null)try{return this.removeForcedVariation(r,i,t,this.logger),!0}catch(s){return this.logger.log(_.ERROR,s.message),!1}var a=m.getVariationIdFromExperimentAndVariationKey(e,t,n);if(!a)return this.logger.log(_.ERROR,u.sprintf(j.NO_VARIATION_FOR_EXPERIMENT_KEY,v,n,t)),!1;try{return this.__setInForcedVariationMap(r,i,a),!0}catch(s){return this.logger.log(_.ERROR,s.message),!1}};var $i=function(e){return new D(e)},gr=gt.REVENUE,_r=gt.VALUE,hr=function(e,t){if(e&&e.hasOwnProperty(gr)){var r=e[gr],n=parseInt(r,10);return isNaN(n)?(t.log(E.INFO,u.sprintf(I.FAILED_TO_PARSE_REVENUE,"EVENT_TAG_UTILS",r)),null):(t.log(E.INFO,u.sprintf(I.PARSED_REVENUE_VALUE,"EVENT_TAG_UTILS",n)),n)}return null},vr=function(e,t){if(e&&e.hasOwnProperty(_r)){var r=e[_r],n=parseFloat(r);return isNaN(n)?(t.log(E.INFO,u.sprintf(I.FAILED_TO_PARSE_VALUE,"EVENT_TAG_UTILS",r)),null):(t.log(E.INFO,u.sprintf(I.PARSED_NUMERIC_VALUE,"EVENT_TAG_UTILS",n)),n)}return null},Ir="https://logx.optimizely.com/v1/events";function mr(e){var t=e.attributes,r=e.configObj,n=r.anonymizeIP,i=r.botFiltering;n==null&&(n=!1);var o={snapshots:[],visitor_id:e.userId,attributes:[]},a={account_id:r.accountId,project_id:r.projectId,visitors:[o],revision:r.revision,client_name:e.clientEngine,client_version:e.clientVersion,anonymize_ip:n,enrich_decisions:!0};return Object.keys(t||{}).forEach(function(s){var l=t[s];if(lr(s,l)){var c=m.getAttributeId(e.configObj,s,e.logger);c&&a.visitors[0].attributes.push({entity_id:c,key:s,type:"custom",value:t[s]})}}),typeof i=="boolean"&&a.visitors[0].attributes.push({entity_id:O.CONTROL_ATTRIBUTES.BOT_FILTERING,key:O.CONTROL_ATTRIBUTES.BOT_FILTERING,type:"custom",value:i}),a}var Wi=function(e){var t={httpVerb:"POST"},r=mr(e);t.url=Ir;var n,i,o,a=(n=e.configObj,i=e.experimentId,o=e.variationId,{decisions:[{campaign_id:m.getLayerId(n,i),experiment_id:i,variation_id:o}],events:[{entity_id:m.getLayerId(n,i),timestamp:Oe(),key:"campaign_activated",uuid:Ne()}]});return r.visitors[0].snapshots.push(a),t.params=r,t},zi=function(e){var t={httpVerb:"POST"},r=mr(e);t.url=Ir;var n=function(i,o,a,s){var l={events:[]},c={entity_id:m.getEventId(i,o),timestamp:Oe(),uuid:Ne(),key:o};if(a){var f=hr(a,s);f!==null&&(c[O.RESERVED_EVENT_KEYWORDS.REVENUE]=f);var d=vr(a,s);d!==null&&(c[O.RESERVED_EVENT_KEYWORDS.VALUE]=d),c.tags=a}return l.events.push(c),l}(e.configObj,e.eventKey,e.eventTags,e.logger);return r.visitors[0].snapshots=[n],t.params=r,t},ht=S.getLogger("EVENT_BUILDER");function yr(e,t){var r=[];return Object.keys(t||{}).forEach(function(n){var i=t[n];if(lr(n,i)){var o=m.getAttributeId(e,n,ht);o&&r.push({entityId:o,key:n,value:t[n]})}}),r}var Xi=function(e){if(typeof e!="object"||Array.isArray(e)||e===null)throw new Error(u.sprintf(R.INVALID_EVENT_TAGS,"EVENT_TAGS_VALIDATOR"));return!0};function te(e){this.logger=e.logger,this.errorHandler=e.errorHandler,this.__notificationListeners={},u.objectValues(Ae).forEach(function(t){this.__notificationListeners[t]=[]}.bind(this)),this.__listenerId=1}te.prototype.addNotificationListener=function(e,t){try{if(!(u.objectValues(Ae).indexOf(e)>-1))return-1;this.__notificationListeners[e]||(this.__notificationListeners[e]=[]);var r=!1;if((this.__notificationListeners[e]||[]).forEach(function(i){if(i.callback===t)return r=!0,!1}),r)return-1;this.__notificationListeners[e].push({id:this.__listenerId,callback:t});var n=this.__listenerId;return this.__listenerId+=1,n}catch(i){return this.logger.log(E.ERROR,i.message),this.errorHandler.handleError(i),-1}},te.prototype.removeNotificationListener=function(e){try{var t,r;if(Object.keys(this.__notificationListeners).some(function(n){if((this.__notificationListeners[n]||[]).every(function(i,o){return i.id!==e||(t=o,r=n,!1)}),t!==void 0&&r!==void 0)return!0}.bind(this)),t!==void 0&&r!==void 0)return this.__notificationListeners[r].splice(t,1),!0}catch(n){this.logger.log(E.ERROR,n.message),this.errorHandler.handleError(n)}return!1},te.prototype.clearAllNotificationListeners=function(){try{u.objectValues(Ae).forEach(function(e){this.__notificationListeners[e]=[]}.bind(this))}catch(e){this.logger.log(E.ERROR,e.message),this.errorHandler.handleError(e)}},te.prototype.clearNotificationListeners=function(e){try{this.__notificationListeners[e]=[]}catch(t){this.logger.log(E.ERROR,t.message),this.errorHandler.handleError(t)}},te.prototype.sendNotifications=function(e,t){try{(this.__notificationListeners[e]||[]).forEach(function(r){var n=r.callback;try{n(t)}catch(i){this.logger.log(E.ERROR,u.sprintf(I.NOTIFICATION_LISTENER_EXCEPTION,"NOTIFICATION_CENTER",e,i.message))}}.bind(this))}catch(r){this.logger.log(E.ERROR,r.message),this.errorHandler.handleError(r)}};var Ji=function(e){return new te(e)},Zi=function(e){if(typeof e.lookup!="function")throw new Error(u.sprintf(R.INVALID_USER_PROFILE_SERVICE,"USER_PROFILE_SERVICE_VALIDATOR","Missing function 'lookup'"));if(typeof e.save!="function")throw new Error(u.sprintf(R.INVALID_USER_PROFILE_SERVICE,"USER_PROFILE_SERVICE_VALIDATOR","Missing function 'save'"));return!0};function Qi(e,t,r,n){var i=e.experimentFeatureMap[r],o={};if(i){var a=n[i],s=(t.variables||[]).reduce(function(l,c){return l[c.id]={id:c.id,value:c.value},l},{});o=(a||[]).reduce(function(l,c){var f=s[c.id],d=t.featureEnabled&&f?f.value:c.defaultValue;return l[c.key]={id:c.id,key:c.key,type:c.type,value:d},l},{})}return o}function eo(e,t){return(e.featureFlags||[]).reduce(function(r,n){return r[n.key]={id:n.id,key:n.key,experimentsMap:(n.experimentIds||[]).reduce(function(i,o){var a=e.experimentIdMap[o].key;return i[a]=t[a],i},{}),variablesMap:(n.variables||[]).reduce(function(i,o){return i[o.key]={id:o.id,key:o.key,type:o.type,value:o.defaultValue},i},{})},r},{})}var Rr=function(e){var t=function(r){var n=(r.rollouts||[]).reduce(function(o,a){return a.experiments.forEach(function(s){o[s.id]=!0}),o},{}),i=(r.featureFlags||[]).reduce(function(o,a){return o[a.id]=a.variables,o},{});return(r.experiments||[]).reduce(function(o,a){return n[a.id]||(o[a.key]={id:a.id,key:a.key,variationsMap:(a.variations||[]).reduce(function(s,l){return s[l.key]={id:l.id,key:l.key,variablesMap:Qi(r,l,a.id,i)},cr(r,a.id)&&(s[l.key].featureEnabled=l.featureEnabled),s},{})}),o},{})}(e);return{experimentsMap:t,featuresMap:eo(e,t),revision:e.revision}},K=S.getLogger();function ue(e,t){return e instanceof Error?e.message:t||"Unknown error"}function w(e){try{this.__initialize(e)}catch(t){K.error(t),this.__updateListeners=[],this.__configObj=null,this.__optimizelyConfigObj=null,this.__readyPromise=Promise.resolve({success:!1,reason:ue(t,"Error in initialize")})}}w.prototype.__initialize=function(e){if(this.__updateListeners=[],this.jsonSchemaValidator=e.jsonSchemaValidator,!e.datafile&&!e.sdkKey){this.__configObj=null;var t=new Error(u.sprintf(R.DATAFILE_AND_SDK_KEY_MISSING,"PROJECT_CONFIG_MANAGER"));return this.__readyPromise=Promise.resolve({success:!1,reason:ue(t)}),void K.error(t)}var r,n=this.__getDatafileFromConfig(e);if(n)try{this.__configObj=m.tryCreatingProjectConfig({datafile:n,jsonSchemaValidator:this.jsonSchemaValidator,logger:K}),this.__optimizelyConfigObj=Rr(this.__configObj)}catch(o){K.error(o),r=o,this.__configObj=null}else this.__configObj=null;if(e.sdkKey){var i={sdkKey:e.sdkKey};this.__validateDatafileOptions(e.datafileOptions)&&M(i,e.datafileOptions),n&&this.__configObj&&(i.datafile=n),this.datafileManager=new Mi(i),this.datafileManager.start(),this.__readyPromise=this.datafileManager.onReady().then(this.__onDatafileManagerReadyFulfill.bind(this),this.__onDatafileManagerReadyReject.bind(this)),this.datafileManager.on("update",this.__onDatafileManagerUpdate.bind(this))}else this.__configObj?this.__readyPromise=Promise.resolve({success:!0}):this.__readyPromise=Promise.resolve({success:!1,reason:ue(r,"Invalid datafile")})},w.prototype.__onDatafileManagerReadyFulfill=function(){var e,t=this.datafileManager.get();try{e=m.tryCreatingProjectConfig({datafile:t,jsonSchemaValidator:this.jsonSchemaValidator,logger:K})}catch(r){return K.error(r),{success:!1,reason:ue(r)}}return this.__handleNewConfigObj(e),{success:!0}},w.prototype.__onDatafileManagerReadyReject=function(e){return{success:!1,reason:ue(e,"Failed to become ready")}},w.prototype.__onDatafileManagerUpdate=function(){var e,t=this.datafileManager.get();try{e=m.tryCreatingProjectConfig({datafile:t,jsonSchemaValidator:this.jsonSchemaValidator,logger:K})}catch(r){K.error(r)}e&&this.__handleNewConfigObj(e)},w.prototype.__getDatafileFromConfig=function(e){var t=null;try{e.datafile&&(or(e.datafile),t=typeof e.datafile=="string"||e.datafile instanceof String?JSON.parse(e.datafile):e.datafile)}catch(r){K.error(r)}return t},w.prototype.__validateDatafileOptions=function(e){return e===void 0||typeof e=="object"&&e!==null},w.prototype.__handleNewConfigObj=function(e){var t=this.__configObj;(t?t.revision:"null")!==e.revision&&(this.__configObj=e,this.__optimizelyConfigObj=Rr(e),this.__updateListeners.forEach(function(r){r(e)}))},w.prototype.getConfig=function(){return this.__configObj},w.prototype.getOptimizelyConfig=function(){return this.__optimizelyConfigObj},w.prototype.onReady=function(){return this.__readyPromise},w.prototype.onUpdate=function(e){return this.__updateListeners.push(e),function(){var t=this.__updateListeners.indexOf(e);t>-1&&this.__updateListeners.splice(t,1)}.bind(this)},w.prototype.stop=function(){this.datafileManager&&this.datafileManager.stop(),this.__updateListeners=[]};var to={ProjectConfigManager:w},vt=O.ERROR_MESSAGES,h=O.LOG_LEVEL,L=O.LOG_MESSAGES,Tr=O.DECISION_SOURCES,be=O.FEATURE_VARIABLE_TYPES,Ce=O.DECISION_NOTIFICATION_TYPES,re=O.NOTIFICATION_TYPES;function N(e){var t=e.clientEngine;O.VALID_CLIENT_ENGINES.indexOf(t)===-1&&(e.logger.log(h.INFO,u.sprintf(L.INVALID_CLIENT_ENGINE,"OPTIMIZELY",t)),t=O.NODE_CLIENT_ENGINE),this.clientEngine=t,this.clientVersion=e.clientVersion||O.NODE_CLIENT_VERSION,this.errorHandler=e.errorHandler,this.eventDispatcher=e.eventDispatcher,this.__isOptimizelyConfigValid=e.isValidInstance,this.logger=e.logger,this.projectConfigManager=new to.ProjectConfigManager({datafile:e.datafile,datafileOptions:e.datafileOptions,jsonSchemaValidator:e.jsonSchemaValidator,sdkKey:e.sdkKey}),this.__disposeOnUpdate=this.projectConfigManager.onUpdate(function(n){this.logger.log(h.INFO,u.sprintf(L.UPDATED_OPTIMIZELY_CONFIG,"OPTIMIZELY",n.revision,n.projectId)),this.notificationCenter.sendNotifications(re.OPTIMIZELY_CONFIG_UPDATE)}.bind(this)),this.__readyPromise=this.projectConfigManager.onReady();var r=null;if(e.userProfileService)try{Zi(e.userProfileService)&&(r=e.userProfileService,this.logger.log(h.INFO,u.sprintf(L.VALID_USER_PROFILE_SERVICE,"OPTIMIZELY")))}catch(n){this.logger.log(h.WARNING,n.message)}this.decisionService=$i({userProfileService:r,logger:this.logger,UNSTABLE_conditionEvaluators:e.UNSTABLE_conditionEvaluators}),this.notificationCenter=Ji({logger:this.logger,errorHandler:this.errorHandler}),this.eventProcessor=new tt.LogTierV1EventProcessor({dispatcher:this.eventDispatcher,flushInterval:e.eventFlushInterval,maxQueueSize:e.eventBatchSize,notificationCenter:this.notificationCenter}),this.eventProcessor.start(),this.__readyTimeouts={},this.__nextReadyTimeoutId=0}N.prototype.__isValidInstance=function(){return this.__isOptimizelyConfigValid&&this.projectConfigManager.getConfig()},N.prototype.activate=function(e,t,r){try{if(!this.__isValidInstance())return this.logger.log(h.ERROR,u.sprintf(L.INVALID_OBJECT,"OPTIMIZELY","activate")),null;if(!this.__validateInputs({experiment_key:e,user_id:t},r))return this.__notActivatingExperiment(e,t);var n=this.projectConfigManager.getConfig();if(!n)return null;try{var i=this.getVariation(e,t,r);if(i===null)return this.__notActivatingExperiment(e,t);if(!m.isRunning(n,e)){var o=u.sprintf(L.SHOULD_NOT_DISPATCH_ACTIVATE,"OPTIMIZELY",e);return this.logger.log(h.DEBUG,o),i}return this._sendImpressionEvent(e,i,t,r),i}catch(s){this.logger.log(h.ERROR,s.message);var a=u.sprintf(L.NOT_ACTIVATING_USER,"OPTIMIZELY",t,e);return this.logger.log(h.INFO,a),this.errorHandler.handleError(s),null}}catch(s){return this.logger.log(h.ERROR,s.message),this.errorHandler.handleError(s),null}},N.prototype._sendImpressionEvent=function(e,t,r,n){var i=this.projectConfigManager.getConfig();if(i){var o=function(a){var s=a.configObj,l=a.experimentKey,c=a.variationKey,f=a.userId,d=a.userAttributes,p=a.clientEngine,g=a.clientVersion,T=m.getVariationIdFromExperimentAndVariationKey(s,l,c),A=m.getExperimentId(s,l),X=m.getLayerId(s,A);return{type:"impression",timestamp:Oe(),uuid:Ne(),user:{id:f,attributes:yr(s,d)},context:{accountId:s.accountId,projectId:s.projectId,revision:s.revision,clientName:p,clientVersion:g,anonymizeIP:s.anonymizeIP||!1,botFiltering:s.botFiltering},layer:{id:X},experiment:{id:A,key:l},variation:{id:T,key:c}}}({experimentKey:e,variationKey:t,userId:r,userAttributes:n,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:i});this.eventProcessor.process(o),this.__emitNotificationCenterActivate(e,t,r,n)}},N.prototype.__emitNotificationCenterActivate=function(e,t,r,n){var i=this.projectConfigManager.getConfig();if(i){var o,a=m.getVariationIdFromExperimentAndVariationKey(i,e,t),s=m.getExperimentId(i,e),l={attributes:n,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:i,experimentId:s,userId:r,variationId:a,logger:this.logger},c=Wi(l),f=i.experimentKeyMap[e];f&&f.variationKeyMap&&(o=f.variationKeyMap[t]),this.notificationCenter.sendNotifications(re.ACTIVATE,{experiment:f,userId:r,attributes:n,variation:o,logEvent:c})}},N.prototype.track=function(e,t,r,n){try{if(!this.__isValidInstance())return void this.logger.log(h.ERROR,u.sprintf(L.INVALID_OBJECT,"OPTIMIZELY","track"));if(!this.__validateInputs({user_id:t,event_key:e},r,n))return;var i=this.projectConfigManager.getConfig();if(!i)return;if(!m.eventWithKeyExists(i,e))return this.logger.log(h.WARNING,u.sprintf(O.LOG_MESSAGES.EVENT_KEY_NOT_FOUND,"OPTIMIZELY",e)),void this.logger.log(h.WARNING,u.sprintf(L.NOT_TRACKING_USER,"OPTIMIZELY",t));var o=function(s){var l=s.configObj,c=s.userId,f=s.userAttributes,d=s.clientEngine,p=s.clientVersion,g=s.eventKey,T=s.eventTags,A=m.getEventId(l,g);return{type:"conversion",timestamp:Oe(),uuid:Ne(),user:{id:c,attributes:yr(l,f)},context:{accountId:l.accountId,projectId:l.projectId,revision:l.revision,clientName:d,clientVersion:p,anonymizeIP:l.anonymizeIP||!1,botFiltering:l.botFiltering},event:{id:A,key:g},revenue:hr(T,ht),value:vr(T,ht),tags:T}}({eventKey:e,eventTags:n=this.__filterEmptyValues(n),userId:t,userAttributes:r,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:i});this.logger.log(h.INFO,u.sprintf(O.LOG_MESSAGES.TRACK_EVENT,"OPTIMIZELY",e,t)),this.eventProcessor.process(o),this.__emitNotificationCenterTrack(e,t,r,n)}catch(s){this.logger.log(h.ERROR,s.message),this.errorHandler.handleError(s);var a=u.sprintf(L.NOT_TRACKING_USER,"OPTIMIZELY",t);this.logger.log(h.ERROR,a)}},N.prototype.__emitNotificationCenterTrack=function(e,t,r,n){try{var i=this.projectConfigManager.getConfig();if(!i)return;var o={attributes:r,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:i,eventKey:e,eventTags:n,logger:this.logger,userId:t},a=zi(o);this.notificationCenter.sendNotifications(re.TRACK,{eventKey:e,userId:t,attributes:r,eventTags:n,logEvent:a})}catch(s){this.logger.log(h.ERROR,s.message),this.errorHandler.handleError(s)}},N.prototype.getVariation=function(e,t,r){try{if(!this.__isValidInstance())return this.logger.log(h.ERROR,u.sprintf(L.INVALID_OBJECT,"OPTIMIZELY","getVariation")),null;try{if(!this.__validateInputs({experiment_key:e,user_id:t},r))return null;var n=this.projectConfigManager.getConfig();if(!n)return null;var i=n.experimentKeyMap[e];if(!i)return this.logger.log(h.DEBUG,u.sprintf(vt.INVALID_EXPERIMENT_KEY,"OPTIMIZELY",e)),null;var o=this.decisionService.getVariation(n,e,t,r),a=m.isFeatureExperiment(n,i.id)?Ce.FEATURE_TEST:Ce.AB_TEST;return this.notificationCenter.sendNotifications(re.DECISION,{type:a,userId:t,attributes:r||{},decisionInfo:{experimentKey:e,variationKey:o}}),o}catch(s){return this.logger.log(h.ERROR,s.message),this.errorHandler.handleError(s),null}}catch(s){return this.logger.log(h.ERROR,s.message),this.errorHandler.handleError(s),null}},N.prototype.setForcedVariation=function(e,t,r){if(!this.__validateInputs({experiment_key:e,user_id:t}))return!1;var n=this.projectConfigManager.getConfig();if(!n)return!1;try{return this.decisionService.setForcedVariation(n,e,t,r)}catch(i){return this.logger.log(h.ERROR,i.message),this.errorHandler.handleError(i),!1}},N.prototype.getForcedVariation=function(e,t){if(!this.__validateInputs({experiment_key:e,user_id:t}))return null;var r=this.projectConfigManager.getConfig();if(!r)return null;try{return this.decisionService.getForcedVariation(r,e,t)}catch(n){return this.logger.log(h.ERROR,n.message),this.errorHandler.handleError(n),null}},N.prototype.__validateInputs=function(e,t,r){try{if(e.hasOwnProperty("user_id")){var n=e.user_id;if(typeof n!="string"||n===null||n==="undefined")throw new Error(u.sprintf(vt.INVALID_INPUT_FORMAT,"OPTIMIZELY","user_id"));delete e.user_id}for(var i=Object.keys(e),o=0;o<i.length;o++){var a=i[o];if(!Er(e[a]))throw new Error(u.sprintf(vt.INVALID_INPUT_FORMAT,"OPTIMIZELY",a))}return t&&ji(t),r&&Xi(r),!0}catch(s){return this.logger.log(h.ERROR,s.message),this.errorHandler.handleError(s),!1}},N.prototype.__notActivatingExperiment=function(e,t){var r=u.sprintf(L.NOT_ACTIVATING_USER,"OPTIMIZELY",t,e);return this.logger.log(h.INFO,r),null},N.prototype.__filterEmptyValues=function(e){for(var t in e)!e.hasOwnProperty(t)||e[t]!==null&&e[t]!==void 0||delete e[t];return e},N.prototype.isFeatureEnabled=function(e,t,r){try{if(!this.__isValidInstance())return this.logger.log(h.ERROR,u.sprintf(L.INVALID_OBJECT,"OPTIMIZELY","isFeatureEnabled")),!1;if(!this.__validateInputs({feature_key:e,user_id:t},r))return!1;var n=this.projectConfigManager.getConfig();if(!n)return!1;var i=m.getFeatureFromKey(n,e,this.logger);if(!i)return!1;var o=!1,a=this.decisionService.getVariationForFeature(n,i,t,r),s=a.variation,l={};s&&(o=s.featureEnabled,a.decisionSource===Tr.FEATURE_TEST&&(l={experimentKey:a.experiment.key,variationKey:a.variation.key},this._sendImpressionEvent(a.experiment.key,a.variation.key,t,r))),o===!0?this.logger.log(h.INFO,u.sprintf(L.FEATURE_ENABLED_FOR_USER,"OPTIMIZELY",e,t)):(this.logger.log(h.INFO,u.sprintf(L.FEATURE_NOT_ENABLED_FOR_USER,"OPTIMIZELY",e,t)),o=!1);var c={featureKey:e,featureEnabled:o,source:a.decisionSource,sourceInfo:l};return this.notificationCenter.sendNotifications(re.DECISION,{type:Ce.FEATURE,userId:t,attributes:r||{},decisionInfo:c}),o}catch(f){return this.logger.log(h.ERROR,f.message),this.errorHandler.handleError(f),!1}},N.prototype.getEnabledFeatures=function(e,t){try{var r=[];if(!this.__isValidInstance())return this.logger.log(h.ERROR,u.sprintf(L.INVALID_OBJECT,"OPTIMIZELY","getEnabledFeatures")),r;if(!this.__validateInputs({user_id:e}))return r;var n=this.projectConfigManager.getConfig();return n&&u.objectValues(n.featureKeyMap).forEach(function(i){this.isFeatureEnabled(i.key,e,t)&&r.push(i.key)}.bind(this)),r}catch(i){return this.logger.log(h.ERROR,i.message),this.errorHandler.handleError(i),[]}},N.prototype.getFeatureVariable=function(e,t,r,n){try{return this._getFeatureVariableForType(e,t,null,r,n)}catch(i){return this.logger.log(h.ERROR,i.message),this.errorHandler.handleError(i),null}},N.prototype._getFeatureVariableForType=function(e,t,r,n,i){if(!this.__isValidInstance()){var o=r?"getFeatureVariable"+r.charAt(0).toUpperCase()+r.slice(1):"getFeatureVariable";return this.logger.log(h.ERROR,u.sprintf(L.INVALID_OBJECT,"OPTIMIZELY",o)),null}if(!this.__validateInputs({feature_key:e,variable_key:t,user_id:n},i))return null;var a=this.projectConfigManager.getConfig();if(!a)return null;var s=m.getFeatureFromKey(a,e,this.logger);if(!s)return null;var l=m.getVariableForFeature(a,e,t,this.logger);if(!l)return null;if(r){if(l.type!==r)return this.logger.log(h.WARNING,u.sprintf(L.VARIABLE_REQUESTED_WITH_WRONG_TYPE,"OPTIMIZELY",r,l.type)),null}else r=l.type;var c=!1,f=l.defaultValue,d=this.decisionService.getVariationForFeature(a,s,n,i);if(d.variation!==null){c=d.variation.featureEnabled;var p=m.getVariableValueForVariation(a,l,d.variation,this.logger);p!==null?c===!0?(f=p,this.logger.log(h.INFO,u.sprintf(L.USER_RECEIVED_VARIABLE_VALUE,"OPTIMIZELY",t,s.key,f,n))):this.logger.log(h.INFO,u.sprintf(L.FEATURE_NOT_ENABLED_RETURN_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",s.key,n,t)):this.logger.log(h.INFO,u.sprintf(L.VARIABLE_NOT_USED_RETURN_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",t,d.variation.key))}else this.logger.log(h.INFO,u.sprintf(L.USER_RECEIVED_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",n,t,s.key));var g={};d.decisionSource===Tr.FEATURE_TEST&&(g={experimentKey:d.experiment.key,variationKey:d.variation.key});var T=m.getTypeCastValue(f,r,this.logger);return this.notificationCenter.sendNotifications(re.DECISION,{type:Ce.FEATURE_VARIABLE,userId:n,attributes:i||{},decisionInfo:{featureKey:e,featureEnabled:c,source:d.decisionSource,variableKey:t,variableValue:T,variableType:r,sourceInfo:g}}),T},N.prototype.getFeatureVariableBoolean=function(e,t,r,n){try{return this._getFeatureVariableForType(e,t,be.BOOLEAN,r,n)}catch(i){return this.logger.log(h.ERROR,i.message),this.errorHandler.handleError(i),null}},N.prototype.getFeatureVariableDouble=function(e,t,r,n){try{return this._getFeatureVariableForType(e,t,be.DOUBLE,r,n)}catch(i){return this.logger.log(h.ERROR,i.message),this.errorHandler.handleError(i),null}},N.prototype.getFeatureVariableInteger=function(e,t,r,n){try{return this._getFeatureVariableForType(e,t,be.INTEGER,r,n)}catch(i){return this.logger.log(h.ERROR,i.message),this.errorHandler.handleError(i),null}},N.prototype.getFeatureVariableString=function(e,t,r,n){try{return this._getFeatureVariableForType(e,t,be.STRING,r,n)}catch(i){return this.logger.log(h.ERROR,i.message),this.errorHandler.handleError(i),null}},N.prototype.getOptimizelyConfig=function(){try{return this.projectConfigManager.getConfig()?this.projectConfigManager.getOptimizelyConfig():null}catch(e){return this.logger.log(h.ERROR,e.message),this.errorHandler.handleError(e),null}},N.prototype.close=function(){try{var e=this.eventProcessor.stop();return this.__disposeOnUpdate&&(this.__disposeOnUpdate(),this.__disposeOnUpdate=null),this.projectConfigManager&&this.projectConfigManager.stop(),Object.keys(this.__readyTimeouts).forEach(function(t){var r=this.__readyTimeouts[t];clearTimeout(r.readyTimeout),r.onClose()}.bind(this)),this.__readyTimeouts={},e.then(function(){return{success:!0}},function(t){return{success:!1,reason:String(t)}})}catch(t){return this.logger.log(h.ERROR,t.message),this.errorHandler.handleError(t),Promise.resolve({success:!1,reason:String(t)})}},N.prototype.onReady=function(e){var t,r;typeof e=="object"&&e!==null&&(t=e.timeout),q(t)||(t=3e4);var n=new Promise(function(s){r=s}),i=this.__nextReadyTimeoutId;this.__nextReadyTimeoutId++;var o=function(){delete this.__readyTimeouts[i],r({success:!1,reason:u.sprintf("onReady timeout expired after %s ms",t)})}.bind(this),a=setTimeout(o,t);return this.__readyTimeouts[i]={readyTimeout:a,onClose:function(){r({success:!1,reason:"Instance closed"})}},this.__readyPromise.then(function(){clearTimeout(a),delete this.__readyTimeouts[i],r({success:!0})}.bind(this)),Promise.race([this.__readyPromise,n])};var ro=function(e){return Et(e)&&e>=1},no=function(e){return Et(e)&&e>0},ne=S.getLogger();S.setLogHandler(ur.createLogger()),S.setLogLevel(S.LogLevel.INFO);var It=!1,io=function(e){try{(e=e||{}).errorHandler&&S.setErrorHandler(e.errorHandler),e.logger&&(S.setLogHandler(e.logger),S.setLogLevel(S.LogLevel.NOTSET)),e.logLevel!==void 0&&S.setLogLevel(e.logLevel);try{wi(e),e.isValidInstance=!0}catch(i){ne.error(i),e.isValidInstance=!1}var t;e.eventDispatcher==null?(t=new tt.LocalStoragePendingEventsDispatcher({eventDispatcher:ar}),It||(t.sendPendingEvents(),It=!0)):t=e.eventDispatcher,e=M({clientEngine:O.JAVASCRIPT_CLIENT_ENGINE,eventBatchSize:10,eventFlushInterval:1e3},e,{eventDispatcher:t,logger:ne,errorHandler:S.getErrorHandler()}),ro(e.eventBatchSize)||(ne.warn("Invalid eventBatchSize %s, defaulting to %s",e.eventBatchSize,10),e.eventBatchSize=10),no(e.eventFlushInterval)||(ne.warn("Invalid eventFlushInterval %s, defaulting to %s",e.eventFlushInterval,1e3),e.eventFlushInterval=1e3);var r=new N(e);try{if(typeof window.addEventListener=="function"){var n="onpagehide"in window?"pagehide":"unload";window.addEventListener(n,function(){r.close()},!1)}}catch(i){ne.error(O.LOG_MESSAGES.UNABLE_TO_ATTACH_UNLOAD,"INDEX_BROWSER",i.message)}return r}catch(i){return ne.error(i),null}},oo=function(){It=!1},mt={logging:ur,errorHandler:Bi,eventDispatcher:ar,enums:O,setLogger:S.setLogHandler,setLogLevel:S.setLogLevel,createInstance:io,__internalResetRetryState:oo},ao=Object.defineProperty,Ve=(e,t)=>ao(e,"name",{value:t,configurable:!0});const so={handleError(e){Sr(e)}};function Or(){Nr();const e=document.head.querySelector("meta[name=optimizely-datafile]")?.content;return mt.createInstance({datafile:e,errorHandler:so})}Ve(Or,"createInstance");function Nr(){const e=Ar("optimizely.logLevel");e?mt.setLogLevel(e):mt.setLogger(null)}Ve(Nr,"configureLogger");function Ar(e){try{return window.localStorage?.getItem(e)}catch{return null}}Ve(Ar,"localStorage");async function Sr(e){const t=document.head?.querySelector('meta[name="browser-optimizely-client-errors-url"]')?.content;if(!t)return;const r={message:e.message,stack:e.stack,stacktrace:$e(e),sanitizedUrl:Ye()||window.location.href,user:We()||void 0};try{await fetch(t,{method:"post",body:JSON.stringify(r)})}catch{}}Ve(Sr,"reportError");var uo=Object.defineProperty,Pe=(e,t)=>uo(e,"name",{value:t,configurable:!0});function xe(e){const t=[];for(const r of Lr()){const[n,i]=r.trim().split("=");e===n&&typeof i<"u"&&t.push({key:n,value:i})}return t}Pe(xe,"getCookies");function Lr(){try{return document.cookie.split(";")}catch{return[]}}Pe(Lr,"readCookies");function lo(e,t,r=null,n=!1,i="lax"){let o=document.domain;if(o==null)throw new Error("Unable to get document domain");o.endsWith(".github.com")&&(o="github.com");const a=location.protocol==="https:"?"; secure":"",s=r?`; expires=${r}`:"";n===!1&&(o=`.${o}`);try{document.cookie=`${e}=${t}; path=/; domain=${o}${s}${a}; samesite=${i}`}catch{}}Pe(lo,"setCookie");function co(e,t=!1){let r=document.domain;if(r==null)throw new Error("Unable to get document domain");r.endsWith(".github.com")&&(r="github.com");const n=new Date().getTime(),i=new Date(n-1).toUTCString(),o=location.protocol==="https:"?"; secure":"",a=`; expires=${i}`;t===!1&&(r=`.${r}`);try{document.cookie=`${e}=''; path=/; domain=${r}${a}${o}`}catch{}}Pe(co,"deleteCookie");function x(){if(!(this instanceof x))return new x;this.size=0,this.uid=0,this.selectors=[],this.indexes=Object.create(this.indexes),this.activeIndexes=[]}var le=window.document.documentElement,fo=le.matches||le.webkitMatchesSelector||le.mozMatchesSelector||le.oMatchesSelector||le.msMatchesSelector;x.prototype.matchesSelector=function(e,t){return fo.call(e,t)},x.prototype.querySelectorAll=function(e,t){return t.querySelectorAll(e)},x.prototype.indexes=[];var po=/^#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;x.prototype.indexes.push({name:"ID",selector:function(t){var r;if(r=t.match(po))return r[0].slice(1)},element:function(t){if(t.id)return[t.id]}});var Eo=/^\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;x.prototype.indexes.push({name:"CLASS",selector:function(t){var r;if(r=t.match(Eo))return r[0].slice(1)},element:function(t){var r=t.className;if(r){if(typeof r=="string")return r.split(/\s/);if(typeof r=="object"&&"baseVal"in r)return r.baseVal.split(/\s/)}}});var go=/^((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;x.prototype.indexes.push({name:"TAG",selector:function(t){var r;if(r=t.match(go))return r[0].toUpperCase()},element:function(t){return[t.nodeName.toUpperCase()]}}),x.prototype.indexes.default={name:"UNIVERSAL",selector:function(){return!0},element:function(){return[!0]}};var yt;typeof window.Map=="function"?yt=window.Map:yt=function(){function e(){this.map={}}return e.prototype.get=function(t){return this.map[t+" "]},e.prototype.set=function(t,r){this.map[t+" "]=r},e}();var Ur=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g;function Dr(e,t){e=e.slice(0).concat(e.default);var r=e.length,n,i,o,a,s=t,l,c,f=[];do if(Ur.exec(""),(o=Ur.exec(s))&&(s=o[3],o[2]||!s)){for(n=0;n<r;n++)if(c=e[n],l=c.selector(o[1])){for(i=f.length,a=!1;i--;)if(f[i].index===c&&f[i].key===l){a=!0;break}a||f.push({index:c,key:l});break}}while(o);return f}function _o(e,t){var r,n,i;for(r=0,n=e.length;r<n;r++)if(i=e[r],t.isPrototypeOf(i))return i}x.prototype.logDefaultIndexUsed=function(){},x.prototype.add=function(e,t){var r,n,i,o,a,s,l,c,f=this.activeIndexes,d=this.selectors;if(typeof e=="string"){for(r={id:this.uid++,selector:e,data:t},l=Dr(this.indexes,e),n=0;n<l.length;n++)c=l[n],o=c.key,i=c.index,a=_o(f,i),a||(a=Object.create(i),a.map=new yt,f.push(a)),i===this.indexes.default&&this.logDefaultIndexUsed(r),s=a.map.get(o),s||(s=[],a.map.set(o,s)),s.push(r);this.size++,d.push(e)}},x.prototype.remove=function(e,t){if(typeof e=="string"){var r,n,i,o,a,s,l,c,f=this.activeIndexes,d={},p=arguments.length===1;for(r=Dr(this.indexes,e),i=0;i<r.length;i++)for(n=r[i],o=f.length;o--;)if(s=f[o],n.index.isPrototypeOf(s)){if(l=s.map.get(n.key),l)for(a=l.length;a--;)c=l[a],c.selector===e&&(p||c.data===t)&&(l.splice(a,1),d[c.id]=!0);break}this.size-=Object.keys(d).length}};function br(e,t){return e.id-t.id}x.prototype.queryAll=function(e){if(!this.selectors.length)return[];var t={},r=[],n=this.querySelectorAll(this.selectors.join(", "),e),i,o,a,s,l,c,f,d;for(i=0,a=n.length;i<a;i++)for(l=n[i],c=this.matches(l),o=0,s=c.length;o<s;o++)d=c[o],t[d.id]?f=t[d.id]:(f={id:d.id,selector:d.selector,data:d.data,elements:[]},t[d.id]=f,r.push(f)),f.elements.push(l);return r.sort(br)},x.prototype.matches=function(e){if(!e)return[];var t,r,n,i,o,a,s,l,c,f,d,p=this.activeIndexes,g={},T=[];for(t=0,i=p.length;t<i;t++)if(s=p[t],l=s.element(e),l){for(r=0,o=l.length;r<o;r++)if(c=s.map.get(l[r]))for(n=0,a=c.length;n<a;n++)f=c[n],d=f.id,!g[d]&&this.matchesSelector(e,f.selector)&&(g[d]=!0,T.push(f))}return T.sort(br)};var Me=null,Rt=null,Tt=[];function Cr(e,t){var r=[];function n(){var o=r;r=[],t(o)}function i(){for(var o=arguments.length,a=Array(o),s=0;s<o;s++)a[s]=arguments[s];r.push(a),r.length===1&&Ot(e,n)}return i}function Ot(e,t){Rt||(Rt=new MutationObserver(ho)),Me||(Me=e.createElement("div"),Rt.observe(Me,{attributes:!0})),Tt.push(t),Me.setAttribute("data-twiddle",""+Date.now())}function ho(){var e=Tt;Tt=[];for(var t=0;t<e.length;t++)try{e[t]()}catch(r){setTimeout(function(){throw r},0)}}var Vr=new WeakMap,ce=new WeakMap,Fe=new WeakMap,z=new WeakMap;function ke(e,t){for(var r=0;r<t.length;r++){var n=t[r],i=n[0],o=n[1],a=n[2];i===we?(vo(a,o),Io(a,o)):i===Mr?Pr(a,o):i===Be&&mo(e.observers,o)}}function vo(e,t){if(t instanceof e.elementConstructor){var r=Vr.get(t);if(r||(r=[],Vr.set(t,r)),r.indexOf(e.id)===-1){var n=void 0;if(e.initialize&&(n=e.initialize.call(void 0,t)),n){var i=ce.get(t);i||(i={},ce.set(t,i)),i[""+e.id]=n}r.push(e.id)}}}function Io(e,t){if(t instanceof e.elementConstructor){var r=z.get(t);if(r||(r=[],z.set(t,r)),r.indexOf(e.id)===-1){e.elements.push(t);var n=ce.get(t),i=n?n[""+e.id]:null;if(i&&i.add&&i.add.call(void 0,t),e.subscribe){var o=e.subscribe.call(void 0,t);if(o){var a=Fe.get(t);a||(a={},Fe.set(t,a)),a[""+e.id]=o}}e.add&&e.add.call(void 0,t),r.push(e.id)}}}function Pr(e,t){if(t instanceof e.elementConstructor){var r=z.get(t);if(!!r){var n=e.elements.indexOf(t);if(n!==-1&&e.elements.splice(n,1),n=r.indexOf(e.id),n!==-1){var i=ce.get(t),o=i?i[""+e.id]:null;if(o&&o.remove&&o.remove.call(void 0,t),e.subscribe){var a=Fe.get(t),s=a?a[""+e.id]:null;s&&s.unsubscribe&&s.unsubscribe()}e.remove&&e.remove.call(void 0,t),r.splice(n,1)}r.length===0&&z.delete(t)}}}function mo(e,t){var r=z.get(t);if(!!r){for(var n=r.slice(0),i=0;i<n.length;i++){var o=e[n[i]];if(!!o){var a=o.elements.indexOf(t);a!==-1&&o.elements.splice(a,1);var s=ce.get(t),l=s?s[""+o.id]:null;l&&l.remove&&l.remove.call(void 0,t);var c=Fe.get(t),f=c?c[""+o.id]:null;f&&f.unsubscribe&&f.unsubscribe(),o.remove&&o.remove.call(void 0,t)}}z.delete(t)}}var Nt=null;function yo(e){if(Nt===null){var t=e.createElement("div"),r=e.createElement("div"),n=e.createElement("div");t.appendChild(r),r.appendChild(n),t.innerHTML="",Nt=n.parentNode!==r}return Nt}function xr(e){return"matches"in e||"webkitMatchesSelector"in e||"mozMatchesSelector"in e||"oMatchesSelector"in e||"msMatchesSelector"in e}var we=1,Mr=2,Be=3;function Ro(e,t,r){for(var n=0;n<r.length;n++){var i=r[n];i.type==="childList"?(Fr(e,t,i.addedNodes),To(e,t,i.removedNodes)):i.type==="attributes"&&Ge(e,t,i.target)}yo(e.ownerDocument)&&Ao(e,t)}function Fr(e,t,r){for(var n=0;n<r.length;n++){var i=r[n];if(xr(i))for(var o=e.selectorSet.matches(i),a=0;a<o.length;a++){var s=o[a].data;t.push([we,i,s])}if("querySelectorAll"in i)for(var l=e.selectorSet.queryAll(i),c=0;c<l.length;c++)for(var f=l[c],d=f.data,p=f.elements,g=0;g<p.length;g++)t.push([we,p[g],d])}}function To(e,t,r){for(var n=0;n<r.length;n++){var i=r[n];if("querySelectorAll"in i){t.push([Be,i]);for(var o=i.querySelectorAll("*"),a=0;a<o.length;a++)t.push([Be,o[a]])}}}function Ge(e,t,r){if(xr(r))for(var n=e.selectorSet.matches(r),i=0;i<n.length;i++){var o=n[i].data;t.push([we,r,o])}if("querySelectorAll"in r){var a=z.get(r);if(a)for(var s=0;s<a.length;s++){var l=e.observers[a[s]];l&&(e.selectorSet.matchesSelector(r,l.selector)||t.push([Mr,r,l]))}}}function Oo(e,t,r){if("querySelectorAll"in r){Ge(e,t,r);for(var n=r.querySelectorAll("*"),i=0;i<n.length;i++)Ge(e,t,n[i])}}function No(e,t,r){for(var n=0;n<r.length;n++)for(var i=r[n],o=i.form?i.form.elements:e.rootNode.querySelectorAll("input"),a=0;a<o.length;a++)Ge(e,t,o[a])}function Ao(e,t){for(var r=0;r<e.observers.length;r++){var n=e.observers[r];if(n)for(var i=n.elements,o=0;o<i.length;o++){var a=i[o];a.parentNode||t.push([Be,a])}}}function So(e,t){var r=e.readyState;r==="interactive"||r==="complete"?Ot(e,t):e.addEventListener("DOMContentLoaded",Ot(e,t))}var Lo=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Uo=0;function fe(e){this.rootNode=e.nodeType===9?e.documentElement:e,this.ownerDocument=e.nodeType===9?e:e.ownerDocument,this.observers=[],this.selectorSet=new x,this.mutationObserver=new MutationObserver(Co.bind(this,this)),this._scheduleAddRootNodes=Cr(this.ownerDocument,bo.bind(this,this)),this._handleThrottledChangedTargets=Cr(this.ownerDocument,Po.bind(this,this)),this.rootNode.addEventListener("change",Vo.bind(this,this),!1),So(this.ownerDocument,Do.bind(this,this))}fe.prototype.disconnect=function(){this.mutationObserver.disconnect()},fe.prototype.observe=function(e,t){var r=void 0;typeof t=="function"?r={selector:e,initialize:t}:(typeof t>"u"?"undefined":Lo(t))==="object"?(r=t,r.selector=e):r=e;var n=this,i={id:Uo++,selector:r.selector,initialize:r.initialize,add:r.add,remove:r.remove,subscribe:r.subscribe,elements:[],elementConstructor:r.hasOwnProperty("constructor")?r.constructor:this.ownerDocument.defaultView.Element,abort:function(){n._abortObserving(i)}};return this.selectorSet.add(i.selector,i),this.observers[i.id]=i,this._scheduleAddRootNodes(),i},fe.prototype._abortObserving=function(e){for(var t=e.elements,r=0;r<t.length;r++)Pr(e,t[r]);this.selectorSet.remove(e.selector,e),delete this.observers[e.id]},fe.prototype.triggerObservers=function(e){var t=[];Oo(this,t,e),ke(this,t)};function Do(e){e.mutationObserver.observe(e.rootNode,{childList:!0,attributes:!0,subtree:!0}),e._scheduleAddRootNodes()}function bo(e){var t=[];Fr(e,t,[e.rootNode]),ke(e,t)}function Co(e,t){var r=[];Ro(e,r,t),ke(e,r)}function Vo(e,t){e._handleThrottledChangedTargets(t.target)}function Po(e,t){var r=[];No(e,r,t),ke(e,r)}var At=void 0;function xo(){return At||(At=new fe(window.document)),At}function Mo(){var e;return(e=xo()).observe.apply(e,arguments)}var kr={},wr={},St=new WeakMap,Br=new WeakMap,Lt=new WeakMap,Gr=Object.getOwnPropertyDescriptor(Event.prototype,"currentTarget");function jr(e,t,r){var n=e[t];return e[t]=function(){return r.apply(e,arguments),n.apply(e,arguments)},e}function Fo(e,t,r){var n=[],i=t;do{if(i.nodeType!==1)break;var o=e.matches(i);if(o.length){var a={node:i,observers:o};r?n.unshift(a):n.push(a)}}while(i=i.parentElement);return n}function ko(){St.set(this,!0)}function wo(){St.set(this,!0),Br.set(this,!0)}function Bo(){return Lt.get(this)||null}function Kr(e,t){!Gr||Object.defineProperty(e,"currentTarget",{configurable:!0,enumerable:!0,get:t||Gr.get})}function Go(e){try{return e.eventPhase,!0}catch{return!1}}function jo(e){if(!!Go(e)){var t=e.eventPhase===1?wr:kr,r=t[e.type];if(!!r){var n=Fo(r,e.target,e.eventPhase===1);if(!!n.length){jr(e,"stopPropagation",ko),jr(e,"stopImmediatePropagation",wo),Kr(e,Bo);for(var i=0,o=n.length;i<o&&!St.get(e);i++){var a=n[i];Lt.set(e,a.node);for(var s=0,l=a.observers.length;s<l&&!Br.get(e);s++)a.observers[s].data.call(a.node,e)}Lt.delete(e),Kr(e)}}}}function Hr(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},i=!!n.capture,o=i?wr:kr,a=o[e];a||(a=new x,o[e]=a,document.addEventListener(e,jo,i)),a.add(t,r)}var Ko=Object.defineProperty,de=(e,t)=>Ko(e,"name",{value:t,configurable:!0});let b;(async function(){b=Or(),await b.onReady()})();function qr(e){return e.toLowerCase().replace(/-(.)/g,function(t,r){return r.toUpperCase()})}de(qr,"camelCase");function je(e){const t={};for(const{name:r,value:n}of e.attributes)if(r.startsWith("data-optimizely-meta-")){const i=r.replace("data-optimizely-meta-","");n&&n.trim().length&&(t[qr(i)]=n)}return t}de(je,"getUserAttributes"),Hr("click","[data-optimizely-event]",function(e){if(!b)return;const t=e.currentTarget,r=t.getAttribute("data-optimizely-event")||"",[n,i]=r.trim().split(/\s*,\s*/),o=je(t);n&&i?b.track(n,i,o):n&&b.track(n,Y(),o)}),Mo("[data-optimizely-experiment]",e=>{if(!b)return;const t=e.getAttribute("data-optimizely-experiment");if(!t||e.hidden)return;const r=je(e),n=b.activate(t,Y(),r);if(!n)return;const i=e.querySelectorAll("[data-optimizely-variation]");for(const o of i){const a=o.getAttribute("data-optimizely-variation");o.hidden=a!==n}});const Ho=document.querySelector('meta[name="enabled-homepage-translation-languages"]')?.getAttribute("content")?.split(",")||[],Yr=xe("_locale_experiment").length>0&&xe("_locale_experiment")[0].value==="ko"&&Ho.includes("ko");Yr&&window.location.pathname==="/"&&$r(),Yr&&window.location.pathname==="/join"&&Wr();async function $r(){const e="ko_homepage_translation",t=Y(),r=xe("_locale")[0]?.value?.slice(0,2);b.setForcedVariation(e,t,r),b.activate(e,t);const n=document.querySelectorAll("[data-optimizely-variation]");for(const i of n)i.hidden=r!==i.getAttribute("data-optimizely-variation");for(const i of document.querySelectorAll('form[action^="/join"]'))i.addEventListener("submit",()=>{b.track("submit.homepage_signup",t)});for(const i of document.querySelectorAll('a[href^="/join"]'))i.addEventListener("click",()=>{b.track("click.homepage_signup",t)})}de($r,"runKoreanHomepageExperiment");async function Wr(){document.getElementById("signup-form")?.addEventListener("submit",()=>{const e="ko_homepage_translation",t=Y();b.activate(e,t),b.track("submit.create_account",t)})}de(Wr,"trackSignupsFromKoreanHomepage");const Ke=document.querySelector('meta[name^="user-currency"]');Ke&&window.location.pathname==="/pricing"&&zr();async function zr(){const e=document.querySelector('meta[name^="supported-currencies"]')?.getAttribute("content")?.split(",")||[],t="local_currency_pricing",r="view.pricing_page",n="usd",i="localized_currency",o=Y(),a=Ke?.getAttribute("content")?.toUpperCase(),s=new URLSearchParams(window.location.search);if(a==="USD"||!a||!e.includes(a))return;s.has("currency")&&b.setForcedVariation(t,o,i);const c=b.activate(t,o)===n?"USD":a;b.track(r,o,{requestedCurrency:a});for(const f of document.querySelectorAll("[data-currency]"))f.hidden=f.getAttribute("data-currency")!==c}return de(zr,"runCurrencyExperiment"),Hr("click","#signup_button",function(){if(!b||!Ke)return;const e=new URLSearchParams(document.location.href);if(!(e.get("pricing_exp")&&e.get("ref_page")?.startsWith("/pricing")))return;const r="submit.create_account",n=Ke?.getAttribute("content")?.toUpperCase();b.track(r,Y(),{requestedCurrency:n})}),He.getUserAttributes=je,Object.defineProperty(He,"__esModule",{value:!0}),He})({});
//# sourceMappingURL=optimizely-354accc3.js.map
